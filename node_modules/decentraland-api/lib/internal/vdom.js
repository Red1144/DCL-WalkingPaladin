"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const types_1 = require("./types");
const SubsetMapping_1 = require("./SubsetMapping");
const Diff_1 = require("./Diff");
const ReplaceWholeTreeException_1 = require("./ReplaceWholeTreeException");
const deepEqual_1 = require("../utils/deepEqual");
// tslint:disable:no-console
const innerDone = Symbol('innerDone');
const outerDone = Symbol('outerDone');
let diffcount;
let foundAll = false;
/** Returns the elements conaining a .tag string property */
function filterHavingTag($) {
    return typeof $.tag === 'string';
}
/**
 * Returns element descriptors, it is an array used to identify the given node
 */
function elementDescriptors(el) {
    let output = [];
    output.push(el.tag);
    if (el.attrs) {
        if (el.attrs.key) {
            output.push(el.tag + '.' + el.attrs.key);
        }
        if (el.attrs.id) {
            output.push(el.tag + '#' + el.attrs.id);
        }
        if (el.attrs.src) {
            output.push(el.tag + '%' + el.attrs.src);
        }
    }
    return output;
}
function findUniqueDescriptors(list) {
    let uniqueDescriptors = {};
    let duplicateDescriptors = {};
    let node;
    let descriptors;
    let descriptor;
    let inUnique;
    let inDupes;
    for (let i = 0; i < list.length; i++) {
        node = list[i];
        descriptors = elementDescriptors(node);
        for (let j = 0; j < descriptors.length; j++) {
            descriptor = descriptors[j];
            inUnique = descriptor in uniqueDescriptors;
            inDupes = descriptor in duplicateDescriptors;
            if (!inUnique && !inDupes) {
                uniqueDescriptors[descriptor] = true;
            }
            else if (inUnique) {
                delete uniqueDescriptors[descriptor];
                duplicateDescriptors[descriptor] = true;
            }
        }
    }
    return uniqueDescriptors;
}
function uniqueInBoth(l1, l2) {
    let l1Unique = findUniqueDescriptors(l1);
    let l2Unique = findUniqueDescriptors(l2);
    let inBoth = {};
    let keys = Object.keys(l1Unique);
    let length = keys.length;
    let key;
    for (let i = 0; i < length; i++) {
        key = keys[i];
        if (l2Unique[key]) {
            inBoth[key] = true;
        }
    }
    return inBoth;
}
function removeDone(tree) {
    // @ts-ignore
    delete tree[outerDone];
    // @ts-ignore
    delete tree[innerDone];
    if (tree.children) {
        return tree.children.every(removeDone);
    }
    else {
        return true;
    }
}
function isEqual(e1, e2) {
    let e1Attributes;
    let e2Attributes;
    if (!['tag'].every(function (element) {
        if (e1[element] !== e2[element]) {
            return false;
        }
        return true;
    })) {
        return false;
    }
    if (Boolean(e1.attrs) !== Boolean(e2.attrs)) {
        return false;
    }
    if (Boolean(e1.children) !== Boolean(e2.children)) {
        return false;
    }
    if (e1.attrs) {
        e1Attributes = Object.keys(e1.attrs);
        e2Attributes = Object.keys(e2.attrs);
        if (e1Attributes.length !== e2Attributes.length) {
            return false;
        }
        if (!e1Attributes.every(function (attribute) {
            if (!deepEqual_1.deepEqual(e1.attrs[attribute], e2.attrs[attribute])) {
                return false;
            }
            return true;
        })) {
            return false;
        }
    }
    if (e1.children) {
        if (e1.children.filter(filterHavingTag).length !== e2.children.filter(filterHavingTag).length) {
            return false;
        }
        if (!e1.children.filter(filterHavingTag).every(function (childNode, index) {
            return isEqual(childNode, e2.children.filter(filterHavingTag)[index]);
        })) {
            return false;
        }
    }
    return true;
}
function roughlyEqual(e1, e2, uniqueDescriptors, sameSiblings, preventRecursion = false) {
    let childUniqueDescriptors;
    let nodeList1;
    let nodeList2;
    if (!e1 || !e2) {
        return false;
    }
    if (e1.tag !== e2.tag) {
        return false;
    }
    if (e1.tag in uniqueDescriptors) {
        return true;
    }
    if (e1.attrs && e2.attrs) {
        if (e1.attrs.id) {
            if (e1.attrs.id !== e2.attrs.id) {
                return false;
            }
            else {
                let idDescriptor = e1.tag + '#' + e1.attrs.id;
                if (idDescriptor in uniqueDescriptors) {
                    return true;
                }
            }
        }
        if (e1.attrs.key) {
            if (e1.attrs.key !== e2.attrs.key) {
                return false;
            }
            else {
                let keyDescriptor = e1.tag + '.' + e1.attrs.key;
                if (keyDescriptor in uniqueDescriptors) {
                    return true;
                }
            }
        }
        if (e1.attrs.src) {
            if (e1.attrs.src !== e2.attrs.src) {
                return false;
            }
            else {
                let keyDescriptor = e1.tag + '%' + e1.attrs.src;
                if (keyDescriptor in uniqueDescriptors) {
                    return true;
                }
            }
        }
    }
    if (sameSiblings) {
        return true;
    }
    nodeList1 = e1.children
        ? e1.children
            .slice()
            .filter(filterHavingTag)
            .reverse()
        : [];
    nodeList2 = e2.children
        ? e2.children
            .slice()
            .filter(filterHavingTag)
            .reverse()
        : [];
    if (nodeList1.length !== nodeList2.length) {
        return false;
    }
    if (preventRecursion) {
        return nodeList1.every(function (element, index) {
            return element.tag === nodeList2[index].tag;
        });
    }
    else {
        // note: we only allow one level of recursion at any depth. If 'preventRecursion'
        // was not set, we must explicitly force it to true for child iterations.
        childUniqueDescriptors = uniqueInBoth(nodeList1, nodeList2);
        return nodeList1.every(function (element, index) {
            return roughlyEqual(element, nodeList2[index], childUniqueDescriptors, true, true);
        });
    }
}
function cloneObj(obj) {
    //  TODO: Do we really need to clone here? Is it not enough to just return the original object?
    return JSON.parse(JSON.stringify(obj));
}
/**
 * based on https://en.wikibooks.org/wiki/Algorithm_implementation/Strings/Longest_common_substring#JavaScript
 */
function findCommonSubsets(c1, c2, marked1, marked2) {
    let lcsSize = 0;
    let index = [];
    let c1Length = c1.length;
    let c2Length = c2.length;
    let matches = Array.apply(null, new Array(c1Length + 1)).map(function () {
        return [];
    });
    // set up the matching table
    let uniqueDescriptors = uniqueInBoth(c1, c2);
    // If all of the elements are the same tag, id and class, then we can
    // consider them roughly the same even if they have a different number of
    // children. This will reduce removing and re-adding similar elements.
    let subsetsSame = c1Length === c2Length;
    let origin;
    let ret;
    let c1Index;
    let c2Index;
    let c1Element;
    let c2Element;
    if (subsetsSame) {
        c1.some(function (element, i) {
            let c1Desc = elementDescriptors(element);
            let c2Desc = elementDescriptors(c2[i]);
            if (c1Desc.length !== c2Desc.length) {
                subsetsSame = false;
                return true;
            }
            c1Desc.some(function (description, i) {
                if (description !== c2Desc[i]) {
                    subsetsSame = false;
                    return true;
                }
                return false;
            });
            if (!subsetsSame) {
                return true;
            }
            return false;
        });
    }
    // fill the matches with distance values
    for (c1Index = 0; c1Index < c1Length; c1Index++) {
        c1Element = c1[c1Index];
        for (c2Index = 0; c2Index < c2Length; c2Index++) {
            c2Element = c2[c2Index];
            if (!marked1[c1Index] &&
                !marked2[c2Index] &&
                roughlyEqual(c1Element, c2Element, uniqueDescriptors, subsetsSame)) {
                matches[c1Index + 1][c2Index + 1] = matches[c1Index][c2Index] ? matches[c1Index][c2Index] + 1 : 1;
                if (matches[c1Index + 1][c2Index + 1] >= lcsSize) {
                    lcsSize = matches[c1Index + 1][c2Index + 1];
                    index = [c1Index + 1, c2Index + 1];
                }
            }
            else {
                matches[c1Index + 1][c2Index + 1] = 0;
            }
        }
    }
    if (lcsSize === 0) {
        return undefined;
    }
    origin = [index[0] - lcsSize, index[1] - lcsSize];
    ret = new SubsetMapping_1.SubsetMapping(origin[0], origin[1]);
    ret.length = lcsSize;
    return ret;
}
/**
 * This should really be a predefined function in Array...
 */
function makeArray(n, v) {
    return Array.apply(null, new Array(n)).map(function () {
        return v;
    });
}
/**
 * Generate arrays that indicate which node belongs to which subset,
 * or whether it's actually an orphan node, existing in only one
 * of the two trees, rather than somewhere in both.
 *
 * So if t1 = <img><canvas><br>, t2 = <canvas><br><img>.
 * The longest subset is "<canvas><br>" (length 2), so it will group 0.
 * The second longest is "<img>" (length 1), so it will be group 1.
 * gaps1 will therefore be [1,0,0] and gaps2 [0,0,1].
 *
 * If an element is not part of any group, it will stay being 'true', which
 * is the initial value. For example:
 * t1 = <img><p></p><br><canvas>, t2 = <b></b><br><canvas><img>
 *
 * The "<p></p>" and "<b></b>" do only show up in one of the two and will
 * therefore be marked by "true". The remaining parts are parts of the
 * groups 0 and 1:
 * gaps1 = [1, true, 0, 0], gaps2 = [true, 0, 0, 1]
 *
 */
function getGapInformation(t1, t2, stable) {
    let gaps1 = t1.children
        ? makeArray(t1.children.filter(filterHavingTag).length, true)
        : [];
    let gaps2 = t2.children
        ? makeArray(t2.children.filter(filterHavingTag).length, true)
        : [];
    let group = 0;
    let length = stable.length;
    let i;
    let j;
    let endOld;
    let endNew;
    let subset;
    // give elements from the same subset the same group number
    for (i = 0; i < length; i++) {
        subset = stable[i];
        endOld = subset.oldValue + subset.length;
        endNew = subset.newValue + subset.length;
        for (j = subset.oldValue; j < endOld; j += 1) {
            gaps1[j] = group;
        }
        for (j = subset.newValue; j < endNew; j += 1) {
            gaps2[j] = group;
        }
        group += 1;
    }
    return {
        gaps1: gaps1,
        gaps2: gaps2
    };
}
/**
 * Find all matching subsets, based on immediate child differences only.
 */
function markSubTrees(oldTree, newTree) {
    // note: the child lists are views, and so update as we update old/newTree
    let oldChildren = oldTree.children ? oldTree.children.filter(filterHavingTag) : [];
    let newChildren = newTree.children ? newTree.children.filter(filterHavingTag) : [];
    let marked1 = makeArray(oldChildren.length, false);
    let marked2 = makeArray(newChildren.length, false);
    let subsets = [];
    let subset;
    let returnIndex = function (_, index) {
        return index;
    };
    let markBoth = function (i) {
        if (subset) {
            marked1[subset.oldValue + i] = true;
            marked2[subset.newValue + i] = true;
        }
    };
    let subsetArray;
    do {
        subset = findCommonSubsets(oldChildren, newChildren, marked1, marked2);
        if (subset) {
            subsets.push(subset);
            subsetArray = Array.apply(null, new Array(subset.length)).map(returnIndex);
            // TODO: this might be a for 0..subset.length
            for (let i = 0; i < subsetArray.length; i++) {
                markBoth(subsetArray[i]);
            }
        }
    } while (subset);
    return subsets;
}
class DiffDOM {
    constructor(options = {}) {
        this.options = options;
        this.tracker = [];
        this.t1Orig = undefined;
        this.t2Orig = undefined;
        this.debug = false;
        this.diffcap = 10; // Limit for how many diffs are accepting when debugging. Inactive when debug is false.
        this.maxDepth = false; // False or a numeral. If set to a numeral, limits the level of depth that the the diff mechanism looks for differences. If false, goes through the entire tree.
        this.maxChildCount = false; // False or a numeral. If set to a numeral, does not try to diff the contents of nodes with more children if there are more than maxChildCountDiffCount differences among child nodes.
        this.maxChildCountDiffCount = 3; // Numeral. See maxChildCount.
        this.filterOuterDiff = null;
        this.compress = false;
    }
    // ===== Create a diff =====
    diff(t1Node, t2Node) {
        diffcount = 0;
        if (this.debug) {
            this.t1Orig = t1Node;
            this.t2Orig = t2Node;
        }
        this.tracker = [];
        return this.findDiffs(t1Node, t2Node);
    }
    findDiffs(t1, t2) {
        let diffs;
        do {
            if (this.debug) {
                diffcount += 1;
                if (diffcount > this.diffcap) {
                    // tslint:disable-next-line
                    ;
                    window.diffError = [this.t1Orig, this.t2Orig];
                    throw new Error('surpassed diffcap:' + JSON.stringify(this.t1Orig) + ' -> ' + JSON.stringify(this.t2Orig));
                }
            }
            diffs = this.findNextDiff(t1, t2, []);
            if (diffs.length === 0) {
                // Last check if the elements really are the same now.
                // If not, remove all info about being done and start over.
                // Sometimes a node can be marked as done, but the creation of subsequent diffs means that it has to be changed again.
                if (!isEqual(t1, t2)) {
                    if (foundAll) {
                        console.error('Could not find remaining diffs!');
                        console.trace({ t1, t2 });
                    }
                    else {
                        foundAll = true;
                        removeDone(t1);
                        diffs = this.findNextDiff(t1, t2, []);
                    }
                }
            }
            if (diffs.length > 0) {
                foundAll = false;
                this.tracker.push(...diffs);
                this.applyVirtual(t1, diffs);
            }
        } while (diffs.length > 0);
        return this.tracker;
    }
    findNextDiff(t1, t2, route) {
        let diffs;
        let fdiffs;
        if (this.maxDepth && route.length > this.maxDepth) {
            return [];
        }
        // outer differences?
        if (!t1[outerDone]) {
            diffs = this.findOuterDiff(t1, t2, route);
            if (this.filterOuterDiff) {
                fdiffs = this.filterOuterDiff(t1, t2, diffs);
                if (fdiffs)
                    diffs = fdiffs;
            }
            if (diffs.length > 0) {
                // tslint:disable-next-line:semicolon
                ;
                t1[outerDone] = true;
                return diffs;
            }
            else {
                // tslint:disable-next-line:semicolon
                ;
                t1[outerDone] = true;
            }
        }
        // inner differences?
        if (!t1[innerDone]) {
            diffs = this.findInnerDiff(t1, t2, route);
            if (diffs.length > 0) {
                return diffs;
            }
            else {
                // tslint:disable-next-line:semicolon
                ;
                t1[innerDone] = true;
            }
        }
        // no differences
        return [];
    }
    findOuterDiff(t1, t2, route) {
        let diffs = [];
        let attr;
        let attr1;
        let attr2;
        let attrLength;
        let pos;
        let i;
        if (t1.tag !== t2.tag) {
            return [
                new Diff_1.Diff()
                    .setValue(types_1.Actions.action, types_1.Actions.replaceElement)
                    .setValue(types_1.Actions.oldValue, t1)
                    .setValue(types_1.Actions.newValue, cloneObj(t2))
                    .setValue(types_1.Actions.route, route)
            ];
        }
        let t1Children = t1.children.filter(filterHavingTag);
        let t2Children = t2.children.filter(filterHavingTag);
        if (this.maxChildCount &&
            t1Children &&
            t2Children &&
            t1Children.length > this.maxChildCount &&
            t2Children.length > this.maxChildCount) {
            let childNodesLength = t1Children.length < t2Children.length ? t1Children.length : t2Children.length;
            let childDiffCount = 0;
            let j = 0;
            while (childDiffCount < this.maxChildCountDiffCount && j < childNodesLength) {
                if (!isEqual(t1Children[j], t2Children[j])) {
                    childDiffCount++;
                }
                j++;
            }
            if (childDiffCount === this.maxChildCountDiffCount) {
                return [
                    new Diff_1.Diff()
                        .setValue(types_1.Actions.action, types_1.Actions.replaceElement)
                        .setValue(types_1.Actions.oldValue, cloneObj(t1))
                        .setValue(types_1.Actions.newValue, cloneObj(t2))
                        .setValue(types_1.Actions.route, route)
                ];
            }
        }
        attr1 = t1.attrs ? Object.keys(t1.attrs).sort() : [];
        attr2 = t2.attrs ? Object.keys(t2.attrs).sort() : [];
        attrLength = attr1.length;
        for (i = 0; i < attrLength; i++) {
            attr = attr1[i];
            pos = attr2.indexOf(attr);
            if (pos === -1) {
                diffs.push(new Diff_1.Diff()
                    .setValue(types_1.Actions.action, types_1.Actions.removeAttribute)
                    .setValue(types_1.Actions.route, route)
                    .setValue(types_1.Actions.name, attr));
            }
            else {
                attr2.splice(pos, 1);
                if (!deepEqual_1.deepEqual(t1.attrs[attr], t2.attrs[attr])) {
                    diffs.push(new Diff_1.Diff()
                        .setValue(types_1.Actions.action, types_1.Actions.modifyAttribute)
                        .setValue(types_1.Actions.route, route)
                        .setValue(types_1.Actions.name, attr)
                        .setValue(types_1.Actions.oldValue, t1.attrs[attr])
                        .setValue(types_1.Actions.newValue, t2.attrs[attr]));
                }
            }
        }
        attrLength = attr2.length;
        for (i = 0; i < attrLength; i++) {
            attr = attr2[i];
            diffs.push(new Diff_1.Diff()
                .setValue(types_1.Actions.action, types_1.Actions.addAttribute)
                .setValue(types_1.Actions.route, route)
                .setValue(types_1.Actions.name, attr));
        }
        return diffs;
    }
    findInnerDiff(t1, t2, route) {
        let subtrees = t1.children && t2.children ? markSubTrees(t1, t2) : [];
        let t1ChildNodes = t1.children ? t1.children.filter(filterHavingTag) : [];
        let t2ChildNodes = t2.children ? t2.children.filter(filterHavingTag) : [];
        let childNodesLengthDifference;
        let diffs = [];
        let index = 0;
        let last;
        let e1;
        let e2;
        let i;
        if (subtrees.length > 0) {
            /* One or more groups have been identified among the children of t1
             * and t2.
             */
            diffs = this.attemptGroupRelocation(t1, t2, subtrees, route);
            if (diffs.length > 0) {
                return diffs;
            }
        }
        /* 0 or 1 groups of similar child nodes have been found
         * for t1 and t2. 1 If there is 1, it could be a sign that the
         * contents are the same. When the number of groups is below 2,
         * t1 and t2 are made to have the same length and each of the
         * pairs of child nodes are diffed.
         */
        last = Math.max(t1ChildNodes.length, t2ChildNodes.length);
        if (t1ChildNodes.length !== t2ChildNodes.length) {
            childNodesLengthDifference = true;
        }
        for (i = 0; i < last; i += 1) {
            e1 = t1ChildNodes[i];
            e2 = t2ChildNodes[i];
            if (childNodesLengthDifference) {
                /* t1 and t2 have different amounts of children. Add
                 * and remove as necessary to obtain the same length */
                if (e1 && !e2) {
                    diffs.push(new Diff_1.Diff()
                        .setValue(types_1.Actions.action, types_1.Actions.removeElement)
                        .setValue(types_1.Actions.route, route.concat(index))
                        .setValue(types_1.Actions.element, e1));
                    index -= 1;
                }
                else if (e2 && !e1) {
                    diffs.push(new Diff_1.Diff()
                        .setValue(types_1.Actions.action, types_1.Actions.addElement)
                        .setValue(types_1.Actions.route, route.concat(index))
                        .setValue(types_1.Actions.element, cloneObj(e2)));
                }
            }
            /* We are now guaranteed that children e1 and e2 exist,
             * and that they can be diffed.
             */
            /* Diffs in child nodes should not affect the parent node,
             * so we let these diffs be submitted together with other
             * diffs.
             */
            if (e1 && e2) {
                diffs = diffs.concat(this.findNextDiff(e1, e2, route.concat(index)));
            }
            index += 1;
        }
        // tslint:disable-next-line:semicolon
        ;
        t1[innerDone] = true;
        return diffs;
    }
    attemptGroupRelocation(t1, t2, subtrees, route) {
        /* Either t1.children and t2.children have the same length, or
         * there are at least two groups of similar elements can be found.
         * attempts are made at equalizing t1 with t2. First all initial
         * elements with no group affiliation (gaps=true) are removed (if
         * only in t1) or added (if only in t2). Then the creation of a group
         * relocation diff is attempted.
        */
        let gapInformation = getGapInformation(t1, t2, subtrees);
        let gaps1 = gapInformation.gaps1;
        let gaps2 = gapInformation.gaps2;
        let shortest = Math.min(gaps1.length, gaps2.length);
        let destinationDifferent;
        let toGroup;
        let group;
        let node;
        let diffs = [];
        let index1;
        let index2;
        let j;
        let t1Children = t1.children.filter(filterHavingTag);
        let t2Children = t2.children.filter(filterHavingTag);
        for (index2 = 0, index1 = 0; index2 < shortest; index1 += 1, index2 += 1) {
            if (gaps1[index2] === true) {
                node = t1Children[index1];
                diffs.push(new Diff_1.Diff()
                    .setValue(types_1.Actions.action, types_1.Actions.removeElement)
                    .setValue(types_1.Actions.route, route.concat(index2))
                    .setValue(types_1.Actions.element, cloneObj(node)));
                gaps1.splice(index2, 1);
                shortest = Math.min(gaps1.length, gaps2.length);
                index2 -= 1;
            }
            else if (gaps2[index2] === true) {
                node = t2Children[index2];
                diffs.push(new Diff_1.Diff()
                    .setValue(types_1.Actions.action, types_1.Actions.addElement)
                    .setValue(types_1.Actions.route, route.concat(index2))
                    .setValue(types_1.Actions.element, cloneObj(node)));
                gaps1.splice(index2, 0, true);
                shortest = Math.min(gaps1.length, gaps2.length);
                index1 -= 1;
            }
            else if (gaps1[index2] !== gaps2[index2]) {
                if (diffs.length > 0) {
                    return diffs;
                }
                // group relocation
                group = subtrees[gaps1[index2]];
                toGroup = Math.min(group.newValue, t1Children.length - group.length);
                if (toGroup !== group.oldValue) {
                    // Check whether destination nodes are different than originating ones.
                    destinationDifferent = false;
                    for (j = 0; j < group.length; j += 1) {
                        if (!roughlyEqual(t1Children[toGroup + j], t1Children[group.oldValue + j], {}, false, true)) {
                            destinationDifferent = true;
                        }
                    }
                    if (destinationDifferent) {
                        return [
                            new Diff_1.Diff()
                                .setValue(types_1.Actions.action, types_1.Actions.relocateGroup)
                                .setValue(types_1.Actions.groupLength, group.length)
                                .setValue(types_1.Actions.from, group.oldValue)
                                .setValue(types_1.Actions.to, toGroup)
                                .setValue(types_1.Actions.route, route)
                        ];
                    }
                }
            }
        }
        return diffs;
    }
    // ===== Apply a virtual diff =====
    /** Patches a virtual tree using a list of diffs */
    applyVirtual(tree, diffs) {
        let length = diffs.length;
        if (length === 0) {
            return true;
        }
        for (let i = 0; i < length; i++) {
            let diff = diffs[i];
            this.applyVirtualDiff(tree, diff);
        }
        return true;
    }
    /** Gets a node in the virtual tree by a route */
    getFromVirtualRoute(tree, route) {
        let node = tree;
        let parentNode = undefined;
        let nodeIndex = 0;
        let newRoute = route.slice();
        while (newRoute.length > 0) {
            const ch = node.children.filter(filterHavingTag);
            if (!ch.length) {
                return undefined;
            }
            nodeIndex = newRoute.shift();
            parentNode = node;
            node = ch[nodeIndex];
        }
        return {
            node,
            parentNode,
            nodeIndex
        };
    }
    /** Patches a virtual tree using a diff */
    applyVirtualDiff(tree, diff) {
        let routeInfo = this.getFromVirtualRoute(tree, diff[types_1.Actions.route]);
        let node = routeInfo && routeInfo.node;
        let parentNode = routeInfo && routeInfo.parentNode;
        let nodeIndex = (routeInfo && routeInfo.nodeIndex) || 0;
        let newNode = undefined;
        switch (diff[types_1.Actions.action]) {
            case types_1.Actions.addElement:
                const route = diff[types_1.Actions.route].slice();
                const position = route.pop();
                const x = this.getFromVirtualRoute(tree, route);
                if (x) {
                    node = x.node;
                    newNode = cloneObj(diff[types_1.Actions.element]);
                    // @ts-ignore
                    newNode[outerDone] = true;
                    // @ts-ignore
                    newNode[innerDone] = true;
                    if (!node.children) {
                        node.children = [];
                    }
                    if (newNode) {
                        if (node.children[position]) {
                            node.children.splice(position, 0, newNode);
                        }
                        else {
                            node.children.push(newNode);
                        }
                    }
                }
                break;
            case types_1.Actions.addAttribute:
                if (!node)
                    throw new ReplaceWholeTreeException_1.ReplaceWholeTreeException();
                if (!node.attrs) {
                    node.attrs = {};
                }
                node.attrs[diff[types_1.Actions.name]] = diff[types_1.Actions.value];
                break;
            case types_1.Actions.modifyAttribute:
                if (!node)
                    throw new ReplaceWholeTreeException_1.ReplaceWholeTreeException();
                node.attrs[diff[types_1.Actions.name]] = diff[types_1.Actions.newValue];
                break;
            case types_1.Actions.removeAttribute:
                if (!node)
                    throw new ReplaceWholeTreeException_1.ReplaceWholeTreeException();
                delete node.attrs[diff[types_1.Actions.name]];
                break;
            case types_1.Actions.replaceElement:
                newNode = cloneObj(diff[types_1.Actions.newValue]);
                // @ts-ignore
                newNode[outerDone] = true;
                // @ts-ignore
                newNode[innerDone] = true;
                if (parentNode && newNode) {
                    parentNode.children[nodeIndex] = newNode;
                }
                else {
                    debugger;
                    throw new ReplaceWholeTreeException_1.ReplaceWholeTreeException();
                }
                break;
            case types_1.Actions.relocateGroup:
                if (node) {
                    const nodeArray = node.children.splice(diff[types_1.Actions.from], diff[types_1.Actions.groupLength]).reverse();
                    for (let i = 0; i < nodeArray.length; i++) {
                        node.children.splice(diff[types_1.Actions.to], 0, nodeArray[i]);
                    }
                }
                break;
            case types_1.Actions.removeElement:
                if (!parentNode)
                    throw new ReplaceWholeTreeException_1.ReplaceWholeTreeException();
                parentNode.children.splice(nodeIndex, 1);
                break;
            default:
                console.log('unknown action');
        }
        return undefined;
    }
}
exports.DiffDOM = DiffDOM;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmRvbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbnRlcm5hbC92ZG9tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQXdDO0FBRXhDLG1EQUErQztBQUMvQyxpQ0FBNkI7QUFDN0IsMkVBQXVFO0FBQ3ZFLGtEQUE4QztBQUM5Qyw0QkFBNEI7QUFFNUIsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0FBQ3JDLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQTtBQUVyQyxJQUFJLFNBQWMsQ0FBQTtBQUNsQixJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUE7QUFFcEIsNERBQTREO0FBQzVELFNBQVMsZUFBZSxDQUFDLENBQWtCO0lBQ3pDLE9BQU8sT0FBTyxDQUFDLENBQUMsR0FBRyxLQUFLLFFBQVEsQ0FBQTtBQUNsQyxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLGtCQUFrQixDQUFDLEVBQW1CO0lBQzdDLElBQUksTUFBTSxHQUFhLEVBQUUsQ0FBQTtJQUV6QixNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUVuQixJQUFJLEVBQUUsQ0FBQyxLQUFLLEVBQUU7UUFDWixJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFO1lBQ2hCLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQTtTQUN6QztRQUNELElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUU7WUFDZixNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUE7U0FDeEM7UUFDRCxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFO1lBQ2hC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U0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTt3QkFDekMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGVBQU8sQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7cUJBQ3hEO2lCQUNGO2dCQUNELE1BQUs7WUFDUCxLQUFLLGVBQU8sQ0FBQyxhQUFhO2dCQUN4QixJQUFJLENBQUMsVUFBVTtvQkFBRSxNQUFNLElBQUkscURBQXlCLEVBQUUsQ0FBQTtnQkFDdEQsVUFBVSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFBO2dCQUN4QyxNQUFLO1lBQ1A7Z0JBQ0UsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO1NBQ2hDO1FBRUQsT0FBTyxTQUFTLENBQUE7SUFDbEIsQ0FBQztDQUNGO0FBL2RELDBCQStkQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFjdGlvbnMsIElEaWZmIH0gZnJvbSAnLi90eXBlcydcbmltcG9ydCB7IElTaW1wbGlmaWVkTm9kZSB9IGZyb20gJy4uL2ludGVyZmFjZXMnXG5pbXBvcnQgeyBTdWJzZXRNYXBwaW5nIH0gZnJvbSAnLi9TdWJzZXRNYXBwaW5nJ1xuaW1wb3J0IHsgRGlmZiB9IGZyb20gJy4vRGlmZidcbmltcG9ydCB7IFJlcGxhY2VXaG9sZVRyZWVFeGNlcHRpb24gfSBmcm9tICcuL1JlcGxhY2VXaG9sZVRyZWVFeGNlcHRpb24nXG5pbXBvcnQgeyBkZWVwRXF1YWwgfSBmcm9tICcuLi91dGlscy9kZWVwRXF1YWwnXG4vLyB0c2xpbnQ6ZGlzYWJsZTpuby1jb25zb2xlXG5cbmNvbnN0IGlubmVyRG9uZSA9IFN5bWJvbCgnaW5uZXJEb25lJylcbmNvbnN0IG91dGVyRG9uZSA9IFN5bWJvbCgnb3V0ZXJEb25lJylcblxubGV0IGRpZmZjb3VudDogYW55XG5sZXQgZm91bmRBbGwgPSBmYWxzZVxuXG4vKiogUmV0dXJucyB0aGUgZWxlbWVudHMgY29uYWluaW5nIGEgLnRhZyBzdHJpbmcgcHJvcGVydHkgKi9cbmZ1bmN0aW9uIGZpbHRlckhhdmluZ1RhZygkOiBJU2ltcGxpZmllZE5vZGUpIHtcbiAgcmV0dXJuIHR5cGVvZiAkLnRhZyA9PT0gJ3N0cmluZydcbn1cblxuLyoqXG4gKiBSZXR1cm5zIGVsZW1lbnQgZGVzY3JpcHRvcnMsIGl0IGlzIGFuIGFycmF5IHVzZWQgdG8gaWRlbnRpZnkgdGhlIGdpdmVuIG5vZGVcbiAqL1xuZnVuY3Rpb24gZWxlbWVudERlc2NyaXB0b3JzKGVsOiBJU2ltcGxpZmllZE5vZGUpOiBzdHJpbmdbXSB7XG4gIGxldCBvdXRwdXQ6IHN0cmluZ1tdID0gW11cblxuICBvdXRwdXQucHVzaChlbC50YWcpXG5cbiAgaWYgKGVsLmF0dHJzKSB7XG4gICAgaWYgKGVsLmF0dHJzLmtleSkge1xuICAgICAgb3V0cHV0LnB1c2goZWwudGFnICsgJy4nICsgZWwuYXR0cnMua2V5KVxuICAgIH1cbiAgICBpZiAoZWwuYXR0cnMuaWQpIHtcbiAgICAgIG91dHB1dC5wdXNoKGVsLnRhZyArICcjJyArIGVsLmF0dHJzLmlkKVxuICAgIH1cbiAgICBpZiAoZWwuYXR0cnMuc3JjKSB7XG4gICAgICBvdXRwdXQucHVzaChlbC50YWcgKyAnJScgKyBlbC5hdHRycy5zcmMpXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG91dHB1dFxufVxuXG5mdW5jdGlvbiBmaW5kVW5pcXVlRGVzY3JpcHRvcnMobGlzdDogSVNpbXBsaWZpZWROb2RlW10pIHtcbiAgbGV0IHVuaXF1ZURlc2NyaXB0b3JzOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPiA9IHt9XG4gIGxldCBkdXBsaWNhdGVEZXNjcmlwdG9yczogUmVjb3JkPHN0cmluZywgYm9vbGVhbj4gPSB7fVxuICBsZXQgbm9kZTogSVNpbXBsaWZpZWROb2RlXG4gIGxldCBkZXNjcmlwdG9yczogc3RyaW5nW11cbiAgbGV0IGRlc2NyaXB0b3I6IHN0cmluZ1xuICBsZXQgaW5VbmlxdWU6IGJvb2xlYW5cbiAgbGV0IGluRHVwZXM6IGJvb2xlYW5cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHtcbiAgICBub2RlID0gbGlzdFtpXVxuICAgIGRlc2NyaXB0b3JzID0gZWxlbWVudERlc2NyaXB0b3JzKG5vZGUpXG5cbiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGRlc2NyaXB0b3JzLmxlbmd0aDsgaisrKSB7XG4gICAgICBkZXNjcmlwdG9yID0gZGVzY3JpcHRvcnNbal1cbiAgICAgIGluVW5pcXVlID0gZGVzY3JpcHRvciBpbiB1bmlxdWVEZXNjcmlwdG9yc1xuICAgICAgaW5EdXBlcyA9IGRlc2NyaXB0b3IgaW4gZHVwbGljYXRlRGVzY3JpcHRvcnNcbiAgICAgIGlmICghaW5VbmlxdWUgJiYgIWluRHVwZXMpIHtcbiAgICAgICAgdW5pcXVlRGVzY3JpcHRvcnNbZGVzY3JpcHRvcl0gPSB0cnVlXG4gICAgICB9IGVsc2UgaWYgKGluVW5pcXVlKSB7XG4gICAgICAgIGRlbGV0ZSB1bmlxdWVEZXNjcmlwdG9yc1tkZXNjcmlwdG9yXVxuICAgICAgICBkdXBsaWNhdGVEZXNjcmlwdG9yc1tkZXNjcmlwdG9yXSA9IHRydWVcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gdW5pcXVlRGVzY3JpcHRvcnNcbn1cblxuZnVuY3Rpb24gdW5pcXVlSW5Cb3RoKGwxOiBJU2ltcGxpZmllZE5vZGVbXSwgbDI6IElTaW1wbGlmaWVkTm9kZVtdKSB7XG4gIGxldCBsMVVuaXF1ZSA9IGZpbmRVbmlxdWVEZXNjcmlwdG9ycyhsMSlcbiAgbGV0IGwyVW5pcXVlID0gZmluZFVuaXF1ZURlc2NyaXB0b3JzKGwyKVxuICBsZXQgaW5Cb3RoOiB7IFtkZXNjcmlwdG9yOiBzdHJpbmddOiBib29sZWFuIH0gPSB7fVxuICBsZXQga2V5cyA9IE9iamVjdC5rZXlzKGwxVW5pcXVlKVxuICBsZXQgbGVuZ3RoID0ga2V5cy5sZW5ndGhcbiAgbGV0IGtleTogc3RyaW5nXG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgIGtleSA9IGtleXNbaV1cbiAgICBpZiAobDJVbmlxdWVba2V5XSkge1xuICAgICAgaW5Cb3RoW2tleV0gPSB0cnVlXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGluQm90aFxufVxuXG5mdW5jdGlvbiByZW1vdmVEb25lKHRyZWU6IElTaW1wbGlmaWVkTm9kZSk6IGJvb2xlYW4ge1xuICAvLyBAdHMtaWdub3JlXG4gIGRlbGV0ZSB0cmVlW291dGVyRG9uZV1cbiAgLy8gQHRzLWlnbm9yZVxuICBkZWxldGUgdHJlZVtpbm5lckRvbmVdXG5cbiAgaWYgKHRyZWUuY2hpbGRyZW4pIHtcbiAgICByZXR1cm4gdHJlZS5jaGlsZHJlbi5ldmVyeShyZW1vdmVEb25lKVxuICB9IGVsc2Uge1xuICAgIHJldHVybiB0cnVlXG4gIH1cbn1cblxuZnVuY3Rpb24gaXNFcXVhbChlMTogSVNpbXBsaWZpZWROb2RlLCBlMjogSVNpbXBsaWZpZWROb2RlKSB7XG4gIGxldCBlMUF0dHJpYnV0ZXM6IHN0cmluZ1tdXG4gIGxldCBlMkF0dHJpYnV0ZXM6IHN0cmluZ1tdXG5cbiAgaWYgKFxuICAgICFbJ3RhZyddLmV2ZXJ5KGZ1bmN0aW9uKGVsZW1lbnQ6IGFueSkge1xuICAgICAgaWYgKChlMSBhcyBhbnkpW2VsZW1lbnRdICE9PSAoZTIgYXMgYW55KVtlbGVtZW50XSkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlXG4gICAgfSlcbiAgKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBpZiAoQm9vbGVhbihlMS5hdHRycykgIT09IEJvb2xlYW4oZTIuYXR0cnMpKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBpZiAoQm9vbGVhbihlMS5jaGlsZHJlbikgIT09IEJvb2xlYW4oZTIuY2hpbGRyZW4pKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbiAgaWYgKGUxLmF0dHJzKSB7XG4gICAgZTFBdHRyaWJ1dGVzID0gT2JqZWN0LmtleXMoZTEuYXR0cnMpXG4gICAgZTJBdHRyaWJ1dGVzID0gT2JqZWN0LmtleXMoZTIuYXR0cnMpXG5cbiAgICBpZiAoZTFBdHRyaWJ1dGVzLmxlbmd0aCAhPT0gZTJBdHRyaWJ1dGVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICAgIGlmIChcbiAgICAgICFlMUF0dHJpYnV0ZXMuZXZlcnkoZnVuY3Rpb24oYXR0cmlidXRlKSB7XG4gICAgICAgIGlmICghZGVlcEVxdWFsKGUxLmF0dHJzW2F0dHJpYnV0ZV0sIGUyLmF0dHJzW2F0dHJpYnV0ZV0pKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgIH0pXG4gICAgKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH1cbiAgaWYgKGUxLmNoaWxkcmVuKSB7XG4gICAgaWYgKGUxLmNoaWxkcmVuLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpLmxlbmd0aCAhPT0gZTIuY2hpbGRyZW4uZmlsdGVyKGZpbHRlckhhdmluZ1RhZykubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIWUxLmNoaWxkcmVuLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpLmV2ZXJ5KGZ1bmN0aW9uKGNoaWxkTm9kZSwgaW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIGlzRXF1YWwoY2hpbGROb2RlLCBlMi5jaGlsZHJlbi5maWx0ZXIoZmlsdGVySGF2aW5nVGFnKVtpbmRleF0pXG4gICAgICB9KVxuICAgICkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHRydWVcbn1cblxuZnVuY3Rpb24gcm91Z2hseUVxdWFsKFxuICBlMTogSVNpbXBsaWZpZWROb2RlLFxuICBlMjogSVNpbXBsaWZpZWROb2RlLFxuICB1bmlxdWVEZXNjcmlwdG9yczogeyBbZGVzY3JpcHRvcjogc3RyaW5nXTogYm9vbGVhbiB9LFxuICBzYW1lU2libGluZ3M6IGJvb2xlYW4sXG4gIHByZXZlbnRSZWN1cnNpb24gPSBmYWxzZVxuKTogYm9vbGVhbiB7XG4gIGxldCBjaGlsZFVuaXF1ZURlc2NyaXB0b3JzOiB7IFtkZXNjcmlwdG9yOiBzdHJpbmddOiBib29sZWFuIH1cbiAgbGV0IG5vZGVMaXN0MTogSVNpbXBsaWZpZWROb2RlW11cbiAgbGV0IG5vZGVMaXN0MjogSVNpbXBsaWZpZWROb2RlW11cblxuICBpZiAoIWUxIHx8ICFlMikge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgaWYgKGUxLnRhZyAhPT0gZTIudGFnKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBpZiAoZTEudGFnIGluIHVuaXF1ZURlc2NyaXB0b3JzKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIGlmIChlMS5hdHRycyAmJiBlMi5hdHRycykge1xuICAgIGlmIChlMS5hdHRycy5pZCkge1xuICAgICAgaWYgKGUxLmF0dHJzLmlkICE9PSBlMi5hdHRycy5pZCkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxldCBpZERlc2NyaXB0b3IgPSBlMS50YWcgKyAnIycgKyBlMS5hdHRycy5pZFxuICAgICAgICBpZiAoaWREZXNjcmlwdG9yIGluIHVuaXF1ZURlc2NyaXB0b3JzKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoZTEuYXR0cnMua2V5KSB7XG4gICAgICBpZiAoZTEuYXR0cnMua2V5ICE9PSBlMi5hdHRycy5rZXkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQga2V5RGVzY3JpcHRvciA9IGUxLnRhZyArICcuJyArIGUxLmF0dHJzLmtleVxuICAgICAgICBpZiAoa2V5RGVzY3JpcHRvciBpbiB1bmlxdWVEZXNjcmlwdG9ycykge1xuICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGUxLmF0dHJzLnNyYykge1xuICAgICAgaWYgKGUxLmF0dHJzLnNyYyAhPT0gZTIuYXR0cnMuc3JjKSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IGtleURlc2NyaXB0b3IgPSBlMS50YWcgKyAnJScgKyBlMS5hdHRycy5zcmNcbiAgICAgICAgaWYgKGtleURlc2NyaXB0b3IgaW4gdW5pcXVlRGVzY3JpcHRvcnMpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHNhbWVTaWJsaW5ncykge1xuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBub2RlTGlzdDEgPSBlMS5jaGlsZHJlblxuICAgID8gZTEuY2hpbGRyZW5cbiAgICAgICAgLnNsaWNlKClcbiAgICAgICAgLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpXG4gICAgICAgIC5yZXZlcnNlKClcbiAgICA6IFtdXG4gIG5vZGVMaXN0MiA9IGUyLmNoaWxkcmVuXG4gICAgPyBlMi5jaGlsZHJlblxuICAgICAgICAuc2xpY2UoKVxuICAgICAgICAuZmlsdGVyKGZpbHRlckhhdmluZ1RhZylcbiAgICAgICAgLnJldmVyc2UoKVxuICAgIDogW11cblxuICBpZiAobm9kZUxpc3QxLmxlbmd0aCAhPT0gbm9kZUxpc3QyLmxlbmd0aCkge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgaWYgKHByZXZlbnRSZWN1cnNpb24pIHtcbiAgICByZXR1cm4gbm9kZUxpc3QxLmV2ZXJ5KGZ1bmN0aW9uKGVsZW1lbnQsIGluZGV4KSB7XG4gICAgICByZXR1cm4gZWxlbWVudC50YWcgPT09IG5vZGVMaXN0MltpbmRleF0udGFnXG4gICAgfSlcbiAgfSBlbHNlIHtcbiAgICAvLyBub3RlOiB3ZSBvbmx5IGFsbG93IG9uZSBsZXZlbCBvZiByZWN1cnNpb24gYXQgYW55IGRlcHRoLiBJZiAncHJldmVudFJlY3Vyc2lvbidcbiAgICAvLyB3YXMgbm90IHNldCwgd2UgbXVzdCBleHBsaWNpdGx5IGZvcmNlIGl0IHRvIHRydWUgZm9yIGNoaWxkIGl0ZXJhdGlvbnMuXG4gICAgY2hpbGRVbmlxdWVEZXNjcmlwdG9ycyA9IHVuaXF1ZUluQm90aChub2RlTGlzdDEsIG5vZGVMaXN0MilcbiAgICByZXR1cm4gbm9kZUxpc3QxLmV2ZXJ5KGZ1bmN0aW9uKGVsZW1lbnQsIGluZGV4KSB7XG4gICAgICByZXR1cm4gcm91Z2hseUVxdWFsKGVsZW1lbnQsIG5vZGVMaXN0MltpbmRleF0sIGNoaWxkVW5pcXVlRGVzY3JpcHRvcnMsIHRydWUsIHRydWUpXG4gICAgfSlcbiAgfVxufVxuXG5mdW5jdGlvbiBjbG9uZU9iajxUPihvYmo6IFQpOiBUIHtcbiAgLy8gIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIHRvIGNsb25lIGhlcmU/IElzIGl0IG5vdCBlbm91Z2ggdG8ganVzdCByZXR1cm4gdGhlIG9yaWdpbmFsIG9iamVjdD9cbiAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSlcbn1cblxuLyoqXG4gKiBiYXNlZCBvbiBodHRwczovL2VuLndpa2lib29rcy5vcmcvd2lraS9BbGdvcml0aG1faW1wbGVtZW50YXRpb24vU3RyaW5ncy9Mb25nZXN0X2NvbW1vbl9zdWJzdHJpbmcjSmF2YVNjcmlwdFxuICovXG5mdW5jdGlvbiBmaW5kQ29tbW9uU3Vic2V0cyhcbiAgYzE6IElTaW1wbGlmaWVkTm9kZVtdLFxuICBjMjogSVNpbXBsaWZpZWROb2RlW10sXG4gIG1hcmtlZDE6IGJvb2xlYW5bXSxcbiAgbWFya2VkMjogYm9vbGVhbltdXG4pOiBTdWJzZXRNYXBwaW5nIHwgdm9pZCB7XG4gIGxldCBsY3NTaXplID0gMFxuICBsZXQgaW5kZXg6IG51bWJlcltdID0gW11cbiAgbGV0IGMxTGVuZ3RoID0gYzEubGVuZ3RoXG4gIGxldCBjMkxlbmd0aCA9IGMyLmxlbmd0aFxuICBsZXQgbWF0Y2hlcyA9IEFycmF5LmFwcGx5KG51bGwsIG5ldyBBcnJheShjMUxlbmd0aCArIDEpKS5tYXAoZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIFtdXG4gIH0pXG4gIC8vIHNldCB1cCB0aGUgbWF0Y2hpbmcgdGFibGVcbiAgbGV0IHVuaXF1ZURlc2NyaXB0b3JzID0gdW5pcXVlSW5Cb3RoKGMxLCBjMilcbiAgLy8gSWYgYWxsIG9mIHRoZSBlbGVtZW50cyBhcmUgdGhlIHNhbWUgdGFnLCBpZCBhbmQgY2xhc3MsIHRoZW4gd2UgY2FuXG4gIC8vIGNvbnNpZGVyIHRoZW0gcm91Z2hseSB0aGUgc2FtZSBldmVuIGlmIHRoZXkgaGF2ZSBhIGRpZmZlcmVudCBudW1iZXIgb2ZcbiAgLy8gY2hpbGRyZW4uIFRoaXMgd2lsbCByZWR1Y2UgcmVtb3ZpbmcgYW5kIHJlLWFkZGluZyBzaW1pbGFyIGVsZW1lbnRzLlxuICBsZXQgc3Vic2V0c1NhbWUgPSBjMUxlbmd0aCA9PT0gYzJMZW5ndGhcbiAgbGV0IG9yaWdpblxuICBsZXQgcmV0XG4gIGxldCBjMUluZGV4OiBudW1iZXJcbiAgbGV0IGMySW5kZXg6IG51bWJlclxuICBsZXQgYzFFbGVtZW50OiBJU2ltcGxpZmllZE5vZGVcbiAgbGV0IGMyRWxlbWVudDogSVNpbXBsaWZpZWROb2RlXG5cbiAgaWYgKHN1YnNldHNTYW1lKSB7XG4gICAgYzEuc29tZShmdW5jdGlvbihlbGVtZW50LCBpKSB7XG4gICAgICBsZXQgYzFEZXNjID0gZWxlbWVudERlc2NyaXB0b3JzKGVsZW1lbnQpXG4gICAgICBsZXQgYzJEZXNjID0gZWxlbWVudERlc2NyaXB0b3JzKGMyW2ldKVxuICAgICAgaWYgKGMxRGVzYy5sZW5ndGggIT09IGMyRGVzYy5sZW5ndGgpIHtcbiAgICAgICAgc3Vic2V0c1NhbWUgPSBmYWxzZVxuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfVxuICAgICAgYzFEZXNjLnNvbWUoZnVuY3Rpb24oZGVzY3JpcHRpb24sIGkpIHtcbiAgICAgICAgaWYgKGRlc2NyaXB0aW9uICE9PSBjMkRlc2NbaV0pIHtcbiAgICAgICAgICBzdWJzZXRzU2FtZSA9IGZhbHNlXG4gICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH0pXG4gICAgICBpZiAoIXN1YnNldHNTYW1lKSB7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9KVxuICB9XG5cbiAgLy8gZmlsbCB0aGUgbWF0Y2hlcyB3aXRoIGRpc3RhbmNlIHZhbHVlc1xuICBmb3IgKGMxSW5kZXggPSAwOyBjMUluZGV4IDwgYzFMZW5ndGg7IGMxSW5kZXgrKykge1xuICAgIGMxRWxlbWVudCA9IGMxW2MxSW5kZXhdXG4gICAgZm9yIChjMkluZGV4ID0gMDsgYzJJbmRleCA8IGMyTGVuZ3RoOyBjMkluZGV4KyspIHtcbiAgICAgIGMyRWxlbWVudCA9IGMyW2MySW5kZXhdXG4gICAgICBpZiAoXG4gICAgICAgICFtYXJrZWQxW2MxSW5kZXhdICYmXG4gICAgICAgICFtYXJrZWQyW2MySW5kZXhdICYmXG4gICAgICAgIHJvdWdobHlFcXVhbChjMUVsZW1lbnQsIGMyRWxlbWVudCwgdW5pcXVlRGVzY3JpcHRvcnMsIHN1YnNldHNTYW1lKVxuICAgICAgKSB7XG4gICAgICAgIG1hdGNoZXNbYzFJbmRleCArIDFdW2MySW5kZXggKyAxXSA9IG1hdGNoZXNbYzFJbmRleF1bYzJJbmRleF0gPyBtYXRjaGVzW2MxSW5kZXhdW2MySW5kZXhdICsgMSA6IDFcbiAgICAgICAgaWYgKG1hdGNoZXNbYzFJbmRleCArIDFdW2MySW5kZXggKyAxXSA+PSBsY3NTaXplKSB7XG4gICAgICAgICAgbGNzU2l6ZSA9IG1hdGNoZXNbYzFJbmRleCArIDFdW2MySW5kZXggKyAxXVxuICAgICAgICAgIGluZGV4ID0gW2MxSW5kZXggKyAxLCBjMkluZGV4ICsgMV1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWF0Y2hlc1tjMUluZGV4ICsgMV1bYzJJbmRleCArIDFdID0gMFxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChsY3NTaXplID09PSAwKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZFxuICB9XG4gIG9yaWdpbiA9IFtpbmRleFswXSAtIGxjc1NpemUsIGluZGV4WzFdIC0gbGNzU2l6ZV1cbiAgcmV0ID0gbmV3IFN1YnNldE1hcHBpbmcob3JpZ2luWzBdLCBvcmlnaW5bMV0pXG4gIHJldC5sZW5ndGggPSBsY3NTaXplXG5cbiAgcmV0dXJuIHJldFxufVxuXG4vKipcbiAqIFRoaXMgc2hvdWxkIHJlYWxseSBiZSBhIHByZWRlZmluZWQgZnVuY3Rpb24gaW4gQXJyYXkuLi5cbiAqL1xuZnVuY3Rpb24gbWFrZUFycmF5PFQ+KG46IG51bWJlciwgdjogVCk6IFRbXSB7XG4gIHJldHVybiBBcnJheS5hcHBseShudWxsLCBuZXcgQXJyYXkobikpLm1hcChmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdlxuICB9KVxufVxuXG4vKipcbiAqIEdlbmVyYXRlIGFycmF5cyB0aGF0IGluZGljYXRlIHdoaWNoIG5vZGUgYmVsb25ncyB0byB3aGljaCBzdWJzZXQsXG4gKiBvciB3aGV0aGVyIGl0J3MgYWN0dWFsbHkgYW4gb3JwaGFuIG5vZGUsIGV4aXN0aW5nIGluIG9ubHkgb25lXG4gKiBvZiB0aGUgdHdvIHRyZWVzLCByYXRoZXIgdGhhbiBzb21ld2hlcmUgaW4gYm90aC5cbiAqXG4gKiBTbyBpZiB0MSA9IDxpbWc+PGNhbnZhcz48YnI+LCB0MiA9IDxjYW52YXM+PGJyPjxpbWc+LlxuICogVGhlIGxvbmdlc3Qgc3Vic2V0IGlzIFwiPGNhbnZhcz48YnI+XCIgKGxlbmd0aCAyKSwgc28gaXQgd2lsbCBncm91cCAwLlxuICogVGhlIHNlY29uZCBsb25nZXN0IGlzIFwiPGltZz5cIiAobGVuZ3RoIDEpLCBzbyBpdCB3aWxsIGJlIGdyb3VwIDEuXG4gKiBnYXBzMSB3aWxsIHRoZXJlZm9yZSBiZSBbMSwwLDBdIGFuZCBnYXBzMiBbMCwwLDFdLlxuICpcbiAqIElmIGFuIGVsZW1lbnQgaXMgbm90IHBhcnQgb2YgYW55IGdyb3VwLCBpdCB3aWxsIHN0YXkgYmVpbmcgJ3RydWUnLCB3aGljaFxuICogaXMgdGhlIGluaXRpYWwgdmFsdWUuIEZvciBleGFtcGxlOlxuICogdDEgPSA8aW1nPjxwPjwvcD48YnI+PGNhbnZhcz4sIHQyID0gPGI+PC9iPjxicj48Y2FudmFzPjxpbWc+XG4gKlxuICogVGhlIFwiPHA+PC9wPlwiIGFuZCBcIjxiPjwvYj5cIiBkbyBvbmx5IHNob3cgdXAgaW4gb25lIG9mIHRoZSB0d28gYW5kIHdpbGxcbiAqIHRoZXJlZm9yZSBiZSBtYXJrZWQgYnkgXCJ0cnVlXCIuIFRoZSByZW1haW5pbmcgcGFydHMgYXJlIHBhcnRzIG9mIHRoZVxuICogZ3JvdXBzIDAgYW5kIDE6XG4gKiBnYXBzMSA9IFsxLCB0cnVlLCAwLCAwXSwgZ2FwczIgPSBbdHJ1ZSwgMCwgMCwgMV1cbiAqXG4gKi9cbmZ1bmN0aW9uIGdldEdhcEluZm9ybWF0aW9uKHQxOiBJU2ltcGxpZmllZE5vZGUsIHQyOiBJU2ltcGxpZmllZE5vZGUsIHN0YWJsZTogU3Vic2V0TWFwcGluZ1tdKSB7XG4gIGxldCBnYXBzMTogKG51bWJlciB8IHRydWUpW10gPSB0MS5jaGlsZHJlblxuICAgID8gKG1ha2VBcnJheSh0MS5jaGlsZHJlbi5maWx0ZXIoZmlsdGVySGF2aW5nVGFnKS5sZW5ndGgsIHRydWUpIGFzIHRydWVbXSlcbiAgICA6IFtdXG4gIGxldCBnYXBzMjogKG51bWJlciB8IHRydWUpW10gPSB0Mi5jaGlsZHJlblxuICAgID8gKG1ha2VBcnJheSh0Mi5jaGlsZHJlbi5maWx0ZXIoZmlsdGVySGF2aW5nVGFnKS5sZW5ndGgsIHRydWUpIGFzIHRydWVbXSlcbiAgICA6IFtdXG4gIGxldCBncm91cCA9IDBcbiAgbGV0IGxlbmd0aCA9IHN0YWJsZS5sZW5ndGhcbiAgbGV0IGk6IG51bWJlclxuICBsZXQgajogbnVtYmVyXG4gIGxldCBlbmRPbGQ6IG51bWJlclxuICBsZXQgZW5kTmV3OiBudW1iZXJcbiAgbGV0IHN1YnNldDogU3Vic2V0TWFwcGluZ1xuXG4gIC8vIGdpdmUgZWxlbWVudHMgZnJvbSB0aGUgc2FtZSBzdWJzZXQgdGhlIHNhbWUgZ3JvdXAgbnVtYmVyXG4gIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgIHN1YnNldCA9IHN0YWJsZVtpXVxuICAgIGVuZE9sZCA9IHN1YnNldC5vbGRWYWx1ZSArIHN1YnNldC5sZW5ndGhcbiAgICBlbmROZXcgPSBzdWJzZXQubmV3VmFsdWUgKyBzdWJzZXQubGVuZ3RoXG4gICAgZm9yIChqID0gc3Vic2V0Lm9sZFZhbHVlOyBqIDwgZW5kT2xkOyBqICs9IDEpIHtcbiAgICAgIGdhcHMxW2pdID0gZ3JvdXBcbiAgICB9XG4gICAgZm9yIChqID0gc3Vic2V0Lm5ld1ZhbHVlOyBqIDwgZW5kTmV3OyBqICs9IDEpIHtcbiAgICAgIGdhcHMyW2pdID0gZ3JvdXBcbiAgICB9XG4gICAgZ3JvdXAgKz0gMVxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBnYXBzMTogZ2FwczEsXG4gICAgZ2FwczI6IGdhcHMyXG4gIH1cbn1cblxuLyoqXG4gKiBGaW5kIGFsbCBtYXRjaGluZyBzdWJzZXRzLCBiYXNlZCBvbiBpbW1lZGlhdGUgY2hpbGQgZGlmZmVyZW5jZXMgb25seS5cbiAqL1xuZnVuY3Rpb24gbWFya1N1YlRyZWVzKG9sZFRyZWU6IElTaW1wbGlmaWVkTm9kZSwgbmV3VHJlZTogSVNpbXBsaWZpZWROb2RlKSB7XG4gIC8vIG5vdGU6IHRoZSBjaGlsZCBsaXN0cyBhcmUgdmlld3MsIGFuZCBzbyB1cGRhdGUgYXMgd2UgdXBkYXRlIG9sZC9uZXdUcmVlXG4gIGxldCBvbGRDaGlsZHJlbiA9IG9sZFRyZWUuY2hpbGRyZW4gPyBvbGRUcmVlLmNoaWxkcmVuLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpIDogW11cbiAgbGV0IG5ld0NoaWxkcmVuID0gbmV3VHJlZS5jaGlsZHJlbiA/IG5ld1RyZWUuY2hpbGRyZW4uZmlsdGVyKGZpbHRlckhhdmluZ1RhZykgOiBbXVxuICBsZXQgbWFya2VkMSA9IG1ha2VBcnJheShvbGRDaGlsZHJlbi5sZW5ndGgsIGZhbHNlKVxuICBsZXQgbWFya2VkMiA9IG1ha2VBcnJheShuZXdDaGlsZHJlbi5sZW5ndGgsIGZhbHNlKVxuICBsZXQgc3Vic2V0cyA9IFtdXG4gIGxldCBzdWJzZXQ6IFN1YnNldE1hcHBpbmcgfCB2b2lkXG4gIGxldCByZXR1cm5JbmRleCA9IGZ1bmN0aW9uKF86IGFueSwgaW5kZXg6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIGluZGV4XG4gIH1cbiAgbGV0IG1hcmtCb3RoID0gZnVuY3Rpb24oaTogbnVtYmVyKSB7XG4gICAgaWYgKHN1YnNldCkge1xuICAgICAgbWFya2VkMVtzdWJzZXQub2xkVmFsdWUgKyBpXSA9IHRydWVcbiAgICAgIG1hcmtlZDJbc3Vic2V0Lm5ld1ZhbHVlICsgaV0gPSB0cnVlXG4gICAgfVxuICB9XG4gIGxldCBzdWJzZXRBcnJheTogbnVtYmVyW11cblxuICBkbyB7XG4gICAgc3Vic2V0ID0gZmluZENvbW1vblN1YnNldHMob2xkQ2hpbGRyZW4sIG5ld0NoaWxkcmVuLCBtYXJrZWQxLCBtYXJrZWQyKVxuICAgIGlmIChzdWJzZXQpIHtcbiAgICAgIHN1YnNldHMucHVzaChzdWJzZXQpXG4gICAgICBzdWJzZXRBcnJheSA9IEFycmF5LmFwcGx5KG51bGwsIG5ldyBBcnJheShzdWJzZXQubGVuZ3RoKSkubWFwKHJldHVybkluZGV4KVxuXG4gICAgICAvLyBUT0RPOiB0aGlzIG1pZ2h0IGJlIGEgZm9yIDAuLnN1YnNldC5sZW5ndGhcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3Vic2V0QXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgbWFya0JvdGgoc3Vic2V0QXJyYXlbaV0pXG4gICAgICB9XG4gICAgfVxuICB9IHdoaWxlIChzdWJzZXQpXG4gIHJldHVybiBzdWJzZXRzXG59XG5cbmV4cG9ydCBjbGFzcyBEaWZmRE9NIHtcbiAgdHJhY2tlcjogRGlmZltdID0gW11cbiAgdDFPcmlnOiBJU2ltcGxpZmllZE5vZGUgfCB2b2lkID0gdW5kZWZpbmVkXG4gIHQyT3JpZzogSVNpbXBsaWZpZWROb2RlIHwgdm9pZCA9IHVuZGVmaW5lZFxuICBkZWJ1ZyA9IGZhbHNlXG4gIGRpZmZjYXAgPSAxMCAvLyBMaW1pdCBmb3IgaG93IG1hbnkgZGlmZnMgYXJlIGFjY2VwdGluZyB3aGVuIGRlYnVnZ2luZy4gSW5hY3RpdmUgd2hlbiBkZWJ1ZyBpcyBmYWxzZS5cbiAgbWF4RGVwdGg6IG51bWJlciB8IGZhbHNlID0gZmFsc2UgLy8gRmFsc2Ugb3IgYSBudW1lcmFsLiBJZiBzZXQgdG8gYSBudW1lcmFsLCBsaW1pdHMgdGhlIGxldmVsIG9mIGRlcHRoIHRoYXQgdGhlIHRoZSBkaWZmIG1lY2hhbmlzbSBsb29rcyBmb3IgZGlmZmVyZW5jZXMuIElmIGZhbHNlLCBnb2VzIHRocm91Z2ggdGhlIGVudGlyZSB0cmVlLlxuICBtYXhDaGlsZENvdW50OiBudW1iZXIgfCBmYWxzZSA9IGZhbHNlIC8vIEZhbHNlIG9yIGEgbnVtZXJhbC4gSWYgc2V0IHRvIGEgbnVtZXJhbCwgZG9lcyBub3QgdHJ5IHRvIGRpZmYgdGhlIGNvbnRlbnRzIG9mIG5vZGVzIHdpdGggbW9yZSBjaGlsZHJlbiBpZiB0aGVyZSBhcmUgbW9yZSB0aGFuIG1heENoaWxkQ291bnREaWZmQ291bnQgZGlmZmVyZW5jZXMgYW1vbmcgY2hpbGQgbm9kZXMuXG4gIG1heENoaWxkQ291bnREaWZmQ291bnQgPSAzIC8vIE51bWVyYWwuIFNlZSBtYXhDaGlsZENvdW50LlxuICBmaWx0ZXJPdXRlckRpZmY6IEZ1bmN0aW9uIHwgbnVsbCA9IG51bGxcbiAgY29tcHJlc3MgPSBmYWxzZVxuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBvcHRpb25zID0ge30pIHt9XG5cbiAgLy8gPT09PT0gQ3JlYXRlIGEgZGlmZiA9PT09PVxuXG4gIGRpZmYodDFOb2RlOiBJU2ltcGxpZmllZE5vZGUsIHQyTm9kZTogSVNpbXBsaWZpZWROb2RlKTogRGlmZltdIHtcbiAgICBkaWZmY291bnQgPSAwXG5cbiAgICBpZiAodGhpcy5kZWJ1Zykge1xuICAgICAgdGhpcy50MU9yaWcgPSB0MU5vZGVcbiAgICAgIHRoaXMudDJPcmlnID0gdDJOb2RlXG4gICAgfVxuXG4gICAgdGhpcy50cmFja2VyID0gW11cbiAgICByZXR1cm4gdGhpcy5maW5kRGlmZnModDFOb2RlLCB0Mk5vZGUpXG4gIH1cblxuICBmaW5kRGlmZnModDE6IElTaW1wbGlmaWVkTm9kZSwgdDI6IElTaW1wbGlmaWVkTm9kZSk6IERpZmZbXSB7XG4gICAgbGV0IGRpZmZzOiBEaWZmW11cbiAgICBkbyB7XG4gICAgICBpZiAodGhpcy5kZWJ1Zykge1xuICAgICAgICBkaWZmY291bnQgKz0gMVxuICAgICAgICBpZiAoZGlmZmNvdW50ID4gdGhpcy5kaWZmY2FwKSB7XG4gICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gICAgICAgICAgOyh3aW5kb3cgYXMgYW55KS5kaWZmRXJyb3IgPSBbdGhpcy50MU9yaWcsIHRoaXMudDJPcmlnXVxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignc3VycGFzc2VkIGRpZmZjYXA6JyArIEpTT04uc3RyaW5naWZ5KHRoaXMudDFPcmlnKSArICcgLT4gJyArIEpTT04uc3RyaW5naWZ5KHRoaXMudDJPcmlnKSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZGlmZnMgPSB0aGlzLmZpbmROZXh0RGlmZih0MSwgdDIsIFtdKVxuXG4gICAgICBpZiAoZGlmZnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIC8vIExhc3QgY2hlY2sgaWYgdGhlIGVsZW1lbnRzIHJlYWxseSBhcmUgdGhlIHNhbWUgbm93LlxuICAgICAgICAvLyBJZiBub3QsIHJlbW92ZSBhbGwgaW5mbyBhYm91dCBiZWluZyBkb25lIGFuZCBzdGFydCBvdmVyLlxuICAgICAgICAvLyBTb21ldGltZXMgYSBub2RlIGNhbiBiZSBtYXJrZWQgYXMgZG9uZSwgYnV0IHRoZSBjcmVhdGlvbiBvZiBzdWJzZXF1ZW50IGRpZmZzIG1lYW5zIHRoYXQgaXQgaGFzIHRvIGJlIGNoYW5nZWQgYWdhaW4uXG4gICAgICAgIGlmICghaXNFcXVhbCh0MSwgdDIpKSB7XG4gICAgICAgICAgaWYgKGZvdW5kQWxsKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdDb3VsZCBub3QgZmluZCByZW1haW5pbmcgZGlmZnMhJylcbiAgICAgICAgICAgIGNvbnNvbGUudHJhY2UoeyB0MSwgdDIgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm91bmRBbGwgPSB0cnVlXG4gICAgICAgICAgICByZW1vdmVEb25lKHQxKVxuICAgICAgICAgICAgZGlmZnMgPSB0aGlzLmZpbmROZXh0RGlmZih0MSwgdDIsIFtdKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGRpZmZzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZm91bmRBbGwgPSBmYWxzZVxuICAgICAgICB0aGlzLnRyYWNrZXIucHVzaCguLi5kaWZmcylcbiAgICAgICAgdGhpcy5hcHBseVZpcnR1YWwodDEsIGRpZmZzKVxuICAgICAgfVxuICAgIH0gd2hpbGUgKGRpZmZzLmxlbmd0aCA+IDApXG4gICAgcmV0dXJuIHRoaXMudHJhY2tlclxuICB9XG5cbiAgZmluZE5leHREaWZmKHQxOiBJU2ltcGxpZmllZE5vZGUsIHQyOiBJU2ltcGxpZmllZE5vZGUsIHJvdXRlOiBudW1iZXJbXSk6IERpZmZbXSB7XG4gICAgbGV0IGRpZmZzOiBEaWZmW11cbiAgICBsZXQgZmRpZmZzXG5cbiAgICBpZiAodGhpcy5tYXhEZXB0aCAmJiByb3V0ZS5sZW5ndGggPiB0aGlzLm1heERlcHRoKSB7XG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gICAgLy8gb3V0ZXIgZGlmZmVyZW5jZXM/XG4gICAgaWYgKCEodDEgYXMgYW55KVtvdXRlckRvbmVdKSB7XG4gICAgICBkaWZmcyA9IHRoaXMuZmluZE91dGVyRGlmZih0MSwgdDIsIHJvdXRlKVxuICAgICAgaWYgKHRoaXMuZmlsdGVyT3V0ZXJEaWZmKSB7XG4gICAgICAgIGZkaWZmcyA9IHRoaXMuZmlsdGVyT3V0ZXJEaWZmKHQxLCB0MiwgZGlmZnMpXG4gICAgICAgIGlmIChmZGlmZnMpIGRpZmZzID0gZmRpZmZzXG4gICAgICB9XG4gICAgICBpZiAoZGlmZnMubGVuZ3RoID4gMCkge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c2VtaWNvbG9uXG4gICAgICAgIDsodDEgYXMgYW55KVtvdXRlckRvbmVdID0gdHJ1ZVxuICAgICAgICByZXR1cm4gZGlmZnNcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzZW1pY29sb25cbiAgICAgICAgOyh0MSBhcyBhbnkpW291dGVyRG9uZV0gPSB0cnVlXG4gICAgICB9XG4gICAgfVxuICAgIC8vIGlubmVyIGRpZmZlcmVuY2VzP1xuICAgIGlmICghKHQxIGFzIGFueSlbaW5uZXJEb25lXSkge1xuICAgICAgZGlmZnMgPSB0aGlzLmZpbmRJbm5lckRpZmYodDEsIHQyLCByb3V0ZSlcbiAgICAgIGlmIChkaWZmcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiBkaWZmc1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnNlbWljb2xvblxuICAgICAgICA7KHQxIGFzIGFueSlbaW5uZXJEb25lXSA9IHRydWVcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBubyBkaWZmZXJlbmNlc1xuICAgIHJldHVybiBbXVxuICB9XG4gIGZpbmRPdXRlckRpZmYodDE6IElTaW1wbGlmaWVkTm9kZSwgdDI6IElTaW1wbGlmaWVkTm9kZSwgcm91dGU6IG51bWJlcltdKTogRGlmZltdIHtcbiAgICBsZXQgZGlmZnM6IERpZmZbXSA9IFtdXG4gICAgbGV0IGF0dHJcbiAgICBsZXQgYXR0cjFcbiAgICBsZXQgYXR0cjJcbiAgICBsZXQgYXR0ckxlbmd0aFxuICAgIGxldCBwb3NcbiAgICBsZXQgaVxuXG4gICAgaWYgKHQxLnRhZyAhPT0gdDIudGFnKSB7XG4gICAgICByZXR1cm4gW1xuICAgICAgICBuZXcgRGlmZigpXG4gICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMuYWN0aW9uLCBBY3Rpb25zLnJlcGxhY2VFbGVtZW50KVxuICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLm9sZFZhbHVlLCB0MSlcbiAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5uZXdWYWx1ZSwgY2xvbmVPYmoodDIpKVxuICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLnJvdXRlLCByb3V0ZSlcbiAgICAgIF1cbiAgICB9XG5cbiAgICBsZXQgdDFDaGlsZHJlbiA9IHQxLmNoaWxkcmVuLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpXG4gICAgbGV0IHQyQ2hpbGRyZW4gPSB0Mi5jaGlsZHJlbi5maWx0ZXIoZmlsdGVySGF2aW5nVGFnKVxuXG4gICAgaWYgKFxuICAgICAgdGhpcy5tYXhDaGlsZENvdW50ICYmXG4gICAgICB0MUNoaWxkcmVuICYmXG4gICAgICB0MkNoaWxkcmVuICYmXG4gICAgICB0MUNoaWxkcmVuLmxlbmd0aCA+IHRoaXMubWF4Q2hpbGRDb3VudCAmJlxuICAgICAgdDJDaGlsZHJlbi5sZW5ndGggPiB0aGlzLm1heENoaWxkQ291bnRcbiAgICApIHtcbiAgICAgIGxldCBjaGlsZE5vZGVzTGVuZ3RoID0gdDFDaGlsZHJlbi5sZW5ndGggPCB0MkNoaWxkcmVuLmxlbmd0aCA/IHQxQ2hpbGRyZW4ubGVuZ3RoIDogdDJDaGlsZHJlbi5sZW5ndGhcbiAgICAgIGxldCBjaGlsZERpZmZDb3VudCA9IDBcbiAgICAgIGxldCBqID0gMFxuICAgICAgd2hpbGUgKGNoaWxkRGlmZkNvdW50IDwgdGhpcy5tYXhDaGlsZENvdW50RGlmZkNvdW50ICYmIGogPCBjaGlsZE5vZGVzTGVuZ3RoKSB7XG4gICAgICAgIGlmICghaXNFcXVhbCh0MUNoaWxkcmVuW2pdLCB0MkNoaWxkcmVuW2pdKSkge1xuICAgICAgICAgIGNoaWxkRGlmZkNvdW50KytcbiAgICAgICAgfVxuICAgICAgICBqKytcbiAgICAgIH1cbiAgICAgIGlmIChjaGlsZERpZmZDb3VudCA9PT0gdGhpcy5tYXhDaGlsZENvdW50RGlmZkNvdW50KSB7XG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgbmV3IERpZmYoKVxuICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMuYWN0aW9uLCBBY3Rpb25zLnJlcGxhY2VFbGVtZW50KVxuICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMub2xkVmFsdWUsIGNsb25lT2JqKHQxKSlcbiAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLm5ld1ZhbHVlLCBjbG9uZU9iaih0MikpXG4gICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5yb3V0ZSwgcm91dGUpXG4gICAgICAgIF1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBhdHRyMSA9IHQxLmF0dHJzID8gT2JqZWN0LmtleXModDEuYXR0cnMpLnNvcnQoKSA6IFtdXG4gICAgYXR0cjIgPSB0Mi5hdHRycyA/IE9iamVjdC5rZXlzKHQyLmF0dHJzKS5zb3J0KCkgOiBbXVxuXG4gICAgYXR0ckxlbmd0aCA9IGF0dHIxLmxlbmd0aFxuICAgIGZvciAoaSA9IDA7IGkgPCBhdHRyTGVuZ3RoOyBpKyspIHtcbiAgICAgIGF0dHIgPSBhdHRyMVtpXVxuICAgICAgcG9zID0gYXR0cjIuaW5kZXhPZihhdHRyKVxuICAgICAgaWYgKHBvcyA9PT0gLTEpIHtcbiAgICAgICAgZGlmZnMucHVzaChcbiAgICAgICAgICBuZXcgRGlmZigpXG4gICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5hY3Rpb24sIEFjdGlvbnMucmVtb3ZlQXR0cmlidXRlKVxuICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMucm91dGUsIHJvdXRlKVxuICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMubmFtZSwgYXR0cilcbiAgICAgICAgKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXR0cjIuc3BsaWNlKHBvcywgMSlcbiAgICAgICAgaWYgKCFkZWVwRXF1YWwodDEuYXR0cnNbYXR0cl0sIHQyLmF0dHJzW2F0dHJdKSkge1xuICAgICAgICAgIGRpZmZzLnB1c2goXG4gICAgICAgICAgICBuZXcgRGlmZigpXG4gICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLmFjdGlvbiwgQWN0aW9ucy5tb2RpZnlBdHRyaWJ1dGUpXG4gICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLnJvdXRlLCByb3V0ZSlcbiAgICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMubmFtZSwgYXR0cilcbiAgICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMub2xkVmFsdWUsIHQxLmF0dHJzW2F0dHJdKVxuICAgICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5uZXdWYWx1ZSwgdDIuYXR0cnNbYXR0cl0pXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgYXR0ckxlbmd0aCA9IGF0dHIyLmxlbmd0aFxuICAgIGZvciAoaSA9IDA7IGkgPCBhdHRyTGVuZ3RoOyBpKyspIHtcbiAgICAgIGF0dHIgPSBhdHRyMltpXVxuICAgICAgZGlmZnMucHVzaChcbiAgICAgICAgbmV3IERpZmYoKVxuICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLmFjdGlvbiwgQWN0aW9ucy5hZGRBdHRyaWJ1dGUpXG4gICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMucm91dGUsIHJvdXRlKVxuICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLm5hbWUsIGF0dHIpXG4gICAgICApXG4gICAgfVxuXG4gICAgcmV0dXJuIGRpZmZzXG4gIH1cbiAgZmluZElubmVyRGlmZih0MTogSVNpbXBsaWZpZWROb2RlLCB0MjogSVNpbXBsaWZpZWROb2RlLCByb3V0ZTogbnVtYmVyW10pOiBEaWZmW10ge1xuICAgIGxldCBzdWJ0cmVlcyA9IHQxLmNoaWxkcmVuICYmIHQyLmNoaWxkcmVuID8gbWFya1N1YlRyZWVzKHQxLCB0MikgOiBbXVxuICAgIGxldCB0MUNoaWxkTm9kZXMgPSB0MS5jaGlsZHJlbiA/IHQxLmNoaWxkcmVuLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpIDogW11cbiAgICBsZXQgdDJDaGlsZE5vZGVzID0gdDIuY2hpbGRyZW4gPyB0Mi5jaGlsZHJlbi5maWx0ZXIoZmlsdGVySGF2aW5nVGFnKSA6IFtdXG4gICAgbGV0IGNoaWxkTm9kZXNMZW5ndGhEaWZmZXJlbmNlXG4gICAgbGV0IGRpZmZzOiBEaWZmW10gPSBbXVxuICAgIGxldCBpbmRleCA9IDBcbiAgICBsZXQgbGFzdFxuICAgIGxldCBlMVxuICAgIGxldCBlMlxuICAgIGxldCBpXG5cbiAgICBpZiAoc3VidHJlZXMubGVuZ3RoID4gMCkge1xuICAgICAgLyogT25lIG9yIG1vcmUgZ3JvdXBzIGhhdmUgYmVlbiBpZGVudGlmaWVkIGFtb25nIHRoZSBjaGlsZHJlbiBvZiB0MVxuICAgICAgICogYW5kIHQyLlxuICAgICAgICovXG4gICAgICBkaWZmcyA9IHRoaXMuYXR0ZW1wdEdyb3VwUmVsb2NhdGlvbih0MSwgdDIsIHN1YnRyZWVzLCByb3V0ZSlcbiAgICAgIGlmIChkaWZmcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiBkaWZmc1xuICAgICAgfVxuICAgIH1cblxuICAgIC8qIDAgb3IgMSBncm91cHMgb2Ygc2ltaWxhciBjaGlsZCBub2RlcyBoYXZlIGJlZW4gZm91bmRcbiAgICAgKiBmb3IgdDEgYW5kIHQyLiAxIElmIHRoZXJlIGlzIDEsIGl0IGNvdWxkIGJlIGEgc2lnbiB0aGF0IHRoZVxuICAgICAqIGNvbnRlbnRzIGFyZSB0aGUgc2FtZS4gV2hlbiB0aGUgbnVtYmVyIG9mIGdyb3VwcyBpcyBiZWxvdyAyLFxuICAgICAqIHQxIGFuZCB0MiBhcmUgbWFkZSB0byBoYXZlIHRoZSBzYW1lIGxlbmd0aCBhbmQgZWFjaCBvZiB0aGVcbiAgICAgKiBwYWlycyBvZiBjaGlsZCBub2RlcyBhcmUgZGlmZmVkLlxuICAgICAqL1xuXG4gICAgbGFzdCA9IE1hdGgubWF4KHQxQ2hpbGROb2Rlcy5sZW5ndGgsIHQyQ2hpbGROb2Rlcy5sZW5ndGgpXG4gICAgaWYgKHQxQ2hpbGROb2Rlcy5sZW5ndGggIT09IHQyQ2hpbGROb2Rlcy5sZW5ndGgpIHtcbiAgICAgIGNoaWxkTm9kZXNMZW5ndGhEaWZmZXJlbmNlID0gdHJ1ZVxuICAgIH1cblxuICAgIGZvciAoaSA9IDA7IGkgPCBsYXN0OyBpICs9IDEpIHtcbiAgICAgIGUxID0gdDFDaGlsZE5vZGVzW2ldXG4gICAgICBlMiA9IHQyQ2hpbGROb2Rlc1tpXVxuXG4gICAgICBpZiAoY2hpbGROb2Rlc0xlbmd0aERpZmZlcmVuY2UpIHtcbiAgICAgICAgLyogdDEgYW5kIHQyIGhhdmUgZGlmZmVyZW50IGFtb3VudHMgb2YgY2hpbGRyZW4uIEFkZFxuICAgICAgICAgKiBhbmQgcmVtb3ZlIGFzIG5lY2Vzc2FyeSB0byBvYnRhaW4gdGhlIHNhbWUgbGVuZ3RoICovXG4gICAgICAgIGlmIChlMSAmJiAhZTIpIHtcbiAgICAgICAgICBkaWZmcy5wdXNoKFxuICAgICAgICAgICAgbmV3IERpZmYoKVxuICAgICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5hY3Rpb24sIEFjdGlvbnMucmVtb3ZlRWxlbWVudClcbiAgICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMucm91dGUsIHJvdXRlLmNvbmNhdChpbmRleCkpXG4gICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLmVsZW1lbnQsIGUxKVxuICAgICAgICAgIClcbiAgICAgICAgICBpbmRleCAtPSAxXG4gICAgICAgIH0gZWxzZSBpZiAoZTIgJiYgIWUxKSB7XG4gICAgICAgICAgZGlmZnMucHVzaChcbiAgICAgICAgICAgIG5ldyBEaWZmKClcbiAgICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMuYWN0aW9uLCBBY3Rpb25zLmFkZEVsZW1lbnQpXG4gICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLnJvdXRlLCByb3V0ZS5jb25jYXQoaW5kZXgpKVxuICAgICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5lbGVtZW50LCBjbG9uZU9iaihlMikpXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvKiBXZSBhcmUgbm93IGd1YXJhbnRlZWQgdGhhdCBjaGlsZHJlbiBlMSBhbmQgZTIgZXhpc3QsXG4gICAgICAgKiBhbmQgdGhhdCB0aGV5IGNhbiBiZSBkaWZmZWQuXG4gICAgICAgKi9cbiAgICAgIC8qIERpZmZzIGluIGNoaWxkIG5vZGVzIHNob3VsZCBub3QgYWZmZWN0IHRoZSBwYXJlbnQgbm9kZSxcbiAgICAgICAqIHNvIHdlIGxldCB0aGVzZSBkaWZmcyBiZSBzdWJtaXR0ZWQgdG9nZXRoZXIgd2l0aCBvdGhlclxuICAgICAgICogZGlmZnMuXG4gICAgICAgKi9cblxuICAgICAgaWYgKGUxICYmIGUyKSB7XG4gICAgICAgIGRpZmZzID0gZGlmZnMuY29uY2F0KHRoaXMuZmluZE5leHREaWZmKGUxLCBlMiwgcm91dGUuY29uY2F0KGluZGV4KSkpXG4gICAgICB9XG5cbiAgICAgIGluZGV4ICs9IDFcbiAgICB9XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnNlbWljb2xvblxuICAgIDsodDEgYXMgYW55KVtpbm5lckRvbmVdID0gdHJ1ZVxuICAgIHJldHVybiBkaWZmc1xuICB9XG5cbiAgYXR0ZW1wdEdyb3VwUmVsb2NhdGlvbih0MTogSVNpbXBsaWZpZWROb2RlLCB0MjogSVNpbXBsaWZpZWROb2RlLCBzdWJ0cmVlczogU3Vic2V0TWFwcGluZ1tdLCByb3V0ZTogbnVtYmVyW10pOiBEaWZmW10ge1xuICAgIC8qIEVpdGhlciB0MS5jaGlsZHJlbiBhbmQgdDIuY2hpbGRyZW4gaGF2ZSB0aGUgc2FtZSBsZW5ndGgsIG9yXG4gICAgICogdGhlcmUgYXJlIGF0IGxlYXN0IHR3byBncm91cHMgb2Ygc2ltaWxhciBlbGVtZW50cyBjYW4gYmUgZm91bmQuXG4gICAgICogYXR0ZW1wdHMgYXJlIG1hZGUgYXQgZXF1YWxpemluZyB0MSB3aXRoIHQyLiBGaXJzdCBhbGwgaW5pdGlhbFxuICAgICAqIGVsZW1lbnRzIHdpdGggbm8gZ3JvdXAgYWZmaWxpYXRpb24gKGdhcHM9dHJ1ZSkgYXJlIHJlbW92ZWQgKGlmXG4gICAgICogb25seSBpbiB0MSkgb3IgYWRkZWQgKGlmIG9ubHkgaW4gdDIpLiBUaGVuIHRoZSBjcmVhdGlvbiBvZiBhIGdyb3VwXG4gICAgICogcmVsb2NhdGlvbiBkaWZmIGlzIGF0dGVtcHRlZC5cbiAgICAqL1xuXG4gICAgbGV0IGdhcEluZm9ybWF0aW9uID0gZ2V0R2FwSW5mb3JtYXRpb24odDEsIHQyLCBzdWJ0cmVlcylcbiAgICBsZXQgZ2FwczEgPSBnYXBJbmZvcm1hdGlvbi5nYXBzMVxuICAgIGxldCBnYXBzMiA9IGdhcEluZm9ybWF0aW9uLmdhcHMyXG4gICAgbGV0IHNob3J0ZXN0ID0gTWF0aC5taW4oZ2FwczEubGVuZ3RoLCBnYXBzMi5sZW5ndGgpXG4gICAgbGV0IGRlc3RpbmF0aW9uRGlmZmVyZW50OiBib29sZWFuXG4gICAgbGV0IHRvR3JvdXBcbiAgICBsZXQgZ3JvdXBcbiAgICBsZXQgbm9kZVxuICAgIGxldCBkaWZmczogRGlmZltdID0gW11cbiAgICBsZXQgaW5kZXgxXG4gICAgbGV0IGluZGV4MlxuICAgIGxldCBqXG5cbiAgICBsZXQgdDFDaGlsZHJlbiA9IHQxLmNoaWxkcmVuLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpXG4gICAgbGV0IHQyQ2hpbGRyZW4gPSB0Mi5jaGlsZHJlbi5maWx0ZXIoZmlsdGVySGF2aW5nVGFnKVxuXG4gICAgZm9yIChpbmRleDIgPSAwLCBpbmRleDEgPSAwOyBpbmRleDIgPCBzaG9ydGVzdDsgaW5kZXgxICs9IDEsIGluZGV4MiArPSAxKSB7XG4gICAgICBpZiAoZ2FwczFbaW5kZXgyXSA9PT0gdHJ1ZSkge1xuICAgICAgICBub2RlID0gdDFDaGlsZHJlbltpbmRleDFdXG4gICAgICAgIGRpZmZzLnB1c2goXG4gICAgICAgICAgbmV3IERpZmYoKVxuICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMuYWN0aW9uLCBBY3Rpb25zLnJlbW92ZUVsZW1lbnQpXG4gICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5yb3V0ZSwgcm91dGUuY29uY2F0KGluZGV4MikpXG4gICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5lbGVtZW50LCBjbG9uZU9iaihub2RlKSlcbiAgICAgICAgKVxuICAgICAgICBnYXBzMS5zcGxpY2UoaW5kZXgyLCAxKVxuICAgICAgICBzaG9ydGVzdCA9IE1hdGgubWluKGdhcHMxLmxlbmd0aCwgZ2FwczIubGVuZ3RoKVxuICAgICAgICBpbmRleDIgLT0gMVxuICAgICAgfSBlbHNlIGlmIChnYXBzMltpbmRleDJdID09PSB0cnVlKSB7XG4gICAgICAgIG5vZGUgPSB0MkNoaWxkcmVuW2luZGV4Ml1cblxuICAgICAgICBkaWZmcy5wdXNoKFxuICAgICAgICAgIG5ldyBEaWZmKClcbiAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLmFjdGlvbiwgQWN0aW9ucy5hZGRFbGVtZW50KVxuICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMucm91dGUsIHJvdXRlLmNvbmNhdChpbmRleDIpKVxuICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMuZWxlbWVudCwgY2xvbmVPYmoobm9kZSkpXG4gICAgICAgIClcbiAgICAgICAgZ2FwczEuc3BsaWNlKGluZGV4MiwgMCwgdHJ1ZSlcbiAgICAgICAgc2hvcnRlc3QgPSBNYXRoLm1pbihnYXBzMS5sZW5ndGgsIGdhcHMyLmxlbmd0aClcbiAgICAgICAgaW5kZXgxIC09IDFcbiAgICAgIH0gZWxzZSBpZiAoZ2FwczFbaW5kZXgyXSAhPT0gZ2FwczJbaW5kZXgyXSkge1xuICAgICAgICBpZiAoZGlmZnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHJldHVybiBkaWZmc1xuICAgICAgICB9XG4gICAgICAgIC8vIGdyb3VwIHJlbG9jYXRpb25cbiAgICAgICAgZ3JvdXAgPSBzdWJ0cmVlc1tnYXBzMVtpbmRleDJdIGFzIG51bWJlcl1cbiAgICAgICAgdG9Hcm91cCA9IE1hdGgubWluKGdyb3VwLm5ld1ZhbHVlLCB0MUNoaWxkcmVuLmxlbmd0aCAtIGdyb3VwLmxlbmd0aClcbiAgICAgICAgaWYgKHRvR3JvdXAgIT09IGdyb3VwLm9sZFZhbHVlKSB7XG4gICAgICAgICAgLy8gQ2hlY2sgd2hldGhlciBkZXN0aW5hdGlvbiBub2RlcyBhcmUgZGlmZmVyZW50IHRoYW4gb3JpZ2luYXRpbmcgb25lcy5cbiAgICAgICAgICBkZXN0aW5hdGlvbkRpZmZlcmVudCA9IGZhbHNlXG4gICAgICAgICAgZm9yIChqID0gMDsgaiA8IGdyb3VwLmxlbmd0aDsgaiArPSAxKSB7XG4gICAgICAgICAgICBpZiAoIXJvdWdobHlFcXVhbCh0MUNoaWxkcmVuW3RvR3JvdXAgKyBqXSwgdDFDaGlsZHJlbltncm91cC5vbGRWYWx1ZSArIGpdLCB7fSwgZmFsc2UsIHRydWUpKSB7XG4gICAgICAgICAgICAgIGRlc3RpbmF0aW9uRGlmZmVyZW50ID0gdHJ1ZVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoZGVzdGluYXRpb25EaWZmZXJlbnQpIHtcbiAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgIG5ldyBEaWZmKClcbiAgICAgICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5hY3Rpb24sIEFjdGlvbnMucmVsb2NhdGVHcm91cClcbiAgICAgICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5ncm91cExlbmd0aCwgZ3JvdXAubGVuZ3RoKVxuICAgICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLmZyb20sIGdyb3VwLm9sZFZhbHVlKVxuICAgICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLnRvLCB0b0dyb3VwKVxuICAgICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLnJvdXRlLCByb3V0ZSlcbiAgICAgICAgICAgIF1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGRpZmZzXG4gIH1cblxuICAvLyA9PT09PSBBcHBseSBhIHZpcnR1YWwgZGlmZiA9PT09PVxuXG4gIC8qKiBQYXRjaGVzIGEgdmlydHVhbCB0cmVlIHVzaW5nIGEgbGlzdCBvZiBkaWZmcyAqL1xuICBhcHBseVZpcnR1YWwodHJlZTogSVNpbXBsaWZpZWROb2RlLCBkaWZmczogSURpZmZbXSkge1xuICAgIGxldCBsZW5ndGggPSBkaWZmcy5sZW5ndGhcbiAgICBpZiAobGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgZGlmZiA9IGRpZmZzW2ldXG4gICAgICB0aGlzLmFwcGx5VmlydHVhbERpZmYodHJlZSwgZGlmZilcbiAgICB9XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIC8qKiBHZXRzIGEgbm9kZSBpbiB0aGUgdmlydHVhbCB0cmVlIGJ5IGEgcm91dGUgKi9cbiAgZ2V0RnJvbVZpcnR1YWxSb3V0ZSh0cmVlOiBJU2ltcGxpZmllZE5vZGUsIHJvdXRlOiBudW1iZXJbXSkge1xuICAgIGxldCBub2RlID0gdHJlZVxuICAgIGxldCBwYXJlbnROb2RlOiBJU2ltcGxpZmllZE5vZGUgfCB2b2lkID0gdW5kZWZpbmVkXG4gICAgbGV0IG5vZGVJbmRleDogbnVtYmVyID0gMFxuXG4gICAgbGV0IG5ld1JvdXRlID0gcm91dGUuc2xpY2UoKVxuXG4gICAgd2hpbGUgKG5ld1JvdXRlLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGNoID0gbm9kZS5jaGlsZHJlbi5maWx0ZXIoZmlsdGVySGF2aW5nVGFnKVxuXG4gICAgICBpZiAoIWNoLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgICB9XG5cbiAgICAgIG5vZGVJbmRleCA9IChuZXdSb3V0ZS5zaGlmdCgpIGFzIGFueSkgYXMgbnVtYmVyXG4gICAgICBwYXJlbnROb2RlID0gbm9kZVxuICAgICAgbm9kZSA9IGNoW25vZGVJbmRleF1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgbm9kZSxcbiAgICAgIHBhcmVudE5vZGUsXG4gICAgICBub2RlSW5kZXhcbiAgICB9XG4gIH1cblxuICAvKiogUGF0Y2hlcyBhIHZpcnR1YWwgdHJlZSB1c2luZyBhIGRpZmYgKi9cbiAgYXBwbHlWaXJ0dWFsRGlmZih0cmVlOiBJU2ltcGxpZmllZE5vZGUsIGRpZmY6IElEaWZmKSB7XG4gICAgbGV0IHJvdXRlSW5mbyA9IHRoaXMuZ2V0RnJvbVZpcnR1YWxSb3V0ZSh0cmVlLCBkaWZmW0FjdGlvbnMucm91dGVdKVxuICAgIGxldCBub2RlID0gcm91dGVJbmZvICYmIHJvdXRlSW5mby5ub2RlXG4gICAgbGV0IHBhcmVudE5vZGU6IElTaW1wbGlmaWVkTm9kZSB8IHZvaWQgPSByb3V0ZUluZm8gJiYgcm91dGVJbmZvLnBhcmVudE5vZGVcbiAgICBsZXQgbm9kZUluZGV4ID0gKHJvdXRlSW5mbyAmJiByb3V0ZUluZm8ubm9kZUluZGV4KSB8fCAwXG4gICAgbGV0IG5ld05vZGU6IElTaW1wbGlmaWVkTm9kZSB8IHZvaWQgPSB1bmRlZmluZWRcblxuICAgIHN3aXRjaCAoZGlmZltBY3Rpb25zLmFjdGlvbl0pIHtcbiAgICAgIGNhc2UgQWN0aW9ucy5hZGRFbGVtZW50OlxuICAgICAgICBjb25zdCByb3V0ZSA9IGRpZmZbQWN0aW9ucy5yb3V0ZV0uc2xpY2UoKVxuICAgICAgICBjb25zdCBwb3NpdGlvbiA9IHJvdXRlLnBvcCgpXG4gICAgICAgIGNvbnN0IHggPSB0aGlzLmdldEZyb21WaXJ0dWFsUm91dGUodHJlZSwgcm91dGUpXG4gICAgICAgIGlmICh4KSB7XG4gICAgICAgICAgbm9kZSA9IHgubm9kZVxuICAgICAgICAgIG5ld05vZGUgPSBjbG9uZU9iaihkaWZmW0FjdGlvbnMuZWxlbWVudF0pXG4gICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgIG5ld05vZGVbb3V0ZXJEb25lXSA9IHRydWVcbiAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgbmV3Tm9kZVtpbm5lckRvbmVdID0gdHJ1ZVxuXG4gICAgICAgICAgaWYgKCFub2RlLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICBub2RlLmNoaWxkcmVuID0gW11cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAobmV3Tm9kZSkge1xuICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGRyZW5bcG9zaXRpb25dKSB7XG4gICAgICAgICAgICAgIG5vZGUuY2hpbGRyZW4uc3BsaWNlKHBvc2l0aW9uLCAwLCBuZXdOb2RlKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgbm9kZS5jaGlsZHJlbi5wdXNoKG5ld05vZGUpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIEFjdGlvbnMuYWRkQXR0cmlidXRlOlxuICAgICAgICBpZiAoIW5vZGUpIHRocm93IG5ldyBSZXBsYWNlV2hvbGVUcmVlRXhjZXB0aW9uKClcblxuICAgICAgICBpZiAoIW5vZGUuYXR0cnMpIHtcbiAgICAgICAgICBub2RlLmF0dHJzID0ge31cbiAgICAgICAgfVxuXG4gICAgICAgIG5vZGUuYXR0cnNbZGlmZltBY3Rpb25zLm5hbWVdXSA9IGRpZmZbQWN0aW9ucy52YWx1ZV1cblxuICAgICAgICBicmVha1xuICAgICAgY2FzZSBBY3Rpb25zLm1vZGlmeUF0dHJpYnV0ZTpcbiAgICAgICAgaWYgKCFub2RlKSB0aHJvdyBuZXcgUmVwbGFjZVdob2xlVHJlZUV4Y2VwdGlvbigpXG5cbiAgICAgICAgbm9kZS5hdHRyc1tkaWZmW0FjdGlvbnMubmFtZV1dID0gZGlmZltBY3Rpb25zLm5ld1ZhbHVlXVxuXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIEFjdGlvbnMucmVtb3ZlQXR0cmlidXRlOlxuICAgICAgICBpZiAoIW5vZGUpIHRocm93IG5ldyBSZXBsYWNlV2hvbGVUcmVlRXhjZXB0aW9uKClcblxuICAgICAgICBkZWxldGUgbm9kZS5hdHRyc1tkaWZmW0FjdGlvbnMubmFtZV1dXG5cbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgQWN0aW9ucy5yZXBsYWNlRWxlbWVudDpcbiAgICAgICAgbmV3Tm9kZSA9IGNsb25lT2JqKGRpZmZbQWN0aW9ucy5uZXdWYWx1ZV0pXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgbmV3Tm9kZVtvdXRlckRvbmVdID0gdHJ1ZVxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIG5ld05vZGVbaW5uZXJEb25lXSA9IHRydWVcbiAgICAgICAgaWYgKHBhcmVudE5vZGUgJiYgbmV3Tm9kZSkge1xuICAgICAgICAgIHBhcmVudE5vZGUuY2hpbGRyZW5bbm9kZUluZGV4XSA9IG5ld05vZGVcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkZWJ1Z2dlclxuICAgICAgICAgIHRocm93IG5ldyBSZXBsYWNlV2hvbGVUcmVlRXhjZXB0aW9uKClcbiAgICAgICAgfVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSBBY3Rpb25zLnJlbG9jYXRlR3JvdXA6XG4gICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgY29uc3Qgbm9kZUFycmF5ID0gbm9kZS5jaGlsZHJlbi5zcGxpY2UoZGlmZltBY3Rpb25zLmZyb21dLCBkaWZmW0FjdGlvbnMuZ3JvdXBMZW5ndGhdKS5yZXZlcnNlKClcbiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGVBcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbm9kZS5jaGlsZHJlbi5zcGxpY2UoZGlmZltBY3Rpb25zLnRvXSwgMCwgbm9kZUFycmF5W2ldKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSBBY3Rpb25zLnJlbW92ZUVsZW1lbnQ6XG4gICAgICAgIGlmICghcGFyZW50Tm9kZSkgdGhyb3cgbmV3IFJlcGxhY2VXaG9sZVRyZWVFeGNlcHRpb24oKVxuICAgICAgICBwYXJlbnROb2RlLmNoaWxkcmVuLnNwbGljZShub2RlSW5kZXgsIDEpXG4gICAgICAgIGJyZWFrXG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb25zb2xlLmxvZygndW5rbm93biBhY3Rpb24nKVxuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxufVxuIl19