import { TransportBasedServer } from './TransportBasedServer';
const hasSymbol = typeof Symbol === 'function' && Symbol.for;
const apiNameSymbol = hasSymbol ? Symbol('pluginName') : 0xfea2;
const registeredAPIs = {};
var PrivateHelpers;
(function (PrivateHelpers) {
    function _registerAPI(apiName, api) {
        if (apiNameSymbol in api) {
            throw new Error(`The API you are trying to register is already registered`);
        }
        if (apiName in registeredAPIs) {
            throw new Error(`The API ${apiName} is already registered`);
        }
        if (typeof api !== 'function') {
            throw new Error(`The API ${apiName} is not a class, it is of type ${typeof api}`);
        }
        ;
        api[apiNameSymbol] = apiName;
        registeredAPIs[apiName] = api;
    }
    PrivateHelpers._registerAPI = _registerAPI;
    function unmountAPI(api) {
        if (api.apiWillUnmount) {
            const promise = api.apiWillUnmount();
            if (promise && 'catch' in promise) {
                promise.catch(error => console.error('Error unmounting API', { api, error }));
            }
        }
    }
    PrivateHelpers.unmountAPI = unmountAPI;
    function mountAPI(api) {
        if (api.apiDidMount) {
            const promise = api.apiDidMount();
            if (promise && 'catch' in promise) {
                promise.catch(error => console.error('Error mounting API', { api, error }));
            }
        }
    }
    PrivateHelpers.mountAPI = mountAPI;
})(PrivateHelpers || (PrivateHelpers = {}));
export var ScriptingHostEvents;
(function (ScriptingHostEvents) {
    ScriptingHostEvents["systemWillUnmount"] = "systemWillUnmount";
    ScriptingHostEvents["systemWillEnable"] = "systemWillEnable";
    ScriptingHostEvents["systemDidUnmount"] = "systemDidUnmount";
})(ScriptingHostEvents || (ScriptingHostEvents = {}));
export function getAPIName(klass) {
    return klass[apiNameSymbol] || klass.name || null;
}
export function registerAPI(apiName) {
    return function (api) {
        PrivateHelpers._registerAPI(apiName, api);
    };
}
export class ScriptingHost extends TransportBasedServer {
    constructor(worker) {
        super(worker);
        this.unmounted = false;
        this.apiInstances = new Map();
        this.expose('LoadComponents', this.RPCLoadAPIs.bind(this));
    }
    static async fromTransport(transport) {
        return new ScriptingHost(transport);
    }
    enable() {
        this.emit(ScriptingHostEvents.systemWillEnable);
        this.apiInstances.forEach(PrivateHelpers.mountAPI);
        super.enable();
    }
    getAPIInstance(api) {
        if (typeof api === 'string') {
            if (this.apiInstances.has(api)) {
                return this.apiInstances.get(api);
            }
            if (api in registeredAPIs) {
                return this.initializeAPI(registeredAPIs[api]);
            }
            return null;
        }
        else if (typeof api === 'function') {
            const apiName = getAPIName(api);
            if (apiName !== null) {
                if (this.apiInstances.has(apiName)) {
                    return this.apiInstances.get(apiName);
                }
                return this.initializeAPI(api);
            }
        }
        throw Object.assign(new Error('Cannot get instance of the specified component'), { api });
    }
    unmount() {
        if (this.unmounted)
            return;
        this.notify('SIGKILL');
        this.emit(ScriptingHostEvents.systemWillUnmount);
        try {
            this.apiInstances.forEach(PrivateHelpers.unmountAPI);
            this.apiInstances.clear();
        }
        catch (e) {
            this.emit('error', e);
        }
        this.transport.close();
        this.emit(ScriptingHostEvents.systemDidUnmount);
        this.unmounted = true;
    }
    initializeAPI(ctor) {
        const apiName = getAPIName(ctor);
        if (apiName === null) {
            throw new Error('The plugin is not registered');
        }
        if (this.apiInstances.has(apiName)) {
            return this.apiInstances.get(apiName);
        }
        const apiOptions = {
            apiName,
            on: (event, handler) => this.on(`${apiName}.${event}`, handler),
            notify: (event, params) => this.notify(`${apiName}.${event}`, params),
            expose: (event, handler) => this.expose(`${apiName}.${event}`, handler),
            getAPIInstance: (name) => {
                return this.getAPIInstance(name);
            },
            system: this
        };
        const instance = ctor.factory ? ctor.factory(ctor, apiOptions) : new ctor(apiOptions);
        this.apiInstances.set(apiName, instance);
        return instance;
    }
    async RPCLoadAPIs(apiNames) {
        if (typeof apiNames !== 'object' || !(apiNames instanceof Array)) {
            throw new TypeError('RPCLoadComponents(names) name must be an array of strings');
        }
        const notFound = apiNames
            .map(name => ({ api: this.getAPIInstance(name), name }))
            .filter($ => $.api === null)
            .map($ => $.name);
        if (notFound.length) {
            const message = `Components not found ${notFound.join(',')}`;
            throw new TypeError(message);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0aW5nSG9zdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ob3N0L1NjcmlwdGluZ0hvc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFPN0QsTUFBTSxTQUFTLEdBQUcsT0FBTyxNQUFNLEtBQUssVUFBVSxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUE7QUFFNUQsTUFBTSxhQUFhLEdBQVEsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtBQUVwRSxNQUFNLGNBQWMsR0FBOEIsRUFBRSxDQUFBO0FBRXBELElBQVUsY0FBYyxDQXNDdkI7QUF0Q0QsV0FBVSxjQUFjO0lBQ3RCLFNBQWdCLFlBQVksQ0FBQyxPQUFlLEVBQUUsR0FBa0I7UUFDOUQsSUFBSSxhQUFhLElBQUksR0FBRyxFQUFFO1lBQ3hCLE1BQU0sSUFBSSxLQUFLLENBQUMsMERBQTBELENBQUMsQ0FBQTtTQUM1RTtRQUVELElBQUksT0FBTyxJQUFJLGNBQWMsRUFBRTtZQUM3QixNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsT0FBTyx3QkFBd0IsQ0FBQyxDQUFBO1NBQzVEO1FBRUQsSUFBSSxPQUFRLEdBQVcsS0FBSyxVQUFVLEVBQUU7WUFDdEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLE9BQU8sa0NBQWtDLE9BQU8sR0FBRyxFQUFFLENBQUMsQ0FBQTtTQUNsRjtRQUlELENBQUM7UUFBQyxHQUFXLENBQUMsYUFBYSxDQUFDLEdBQUcsT0FBTyxDQUFBO1FBRXRDLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUE7SUFDL0IsQ0FBQztJQWxCZSwyQkFBWSxlQWtCM0IsQ0FBQTtJQUVELFNBQWdCLFVBQVUsQ0FBQyxHQUFRO1FBQ2pDLElBQUksR0FBRyxDQUFDLGNBQWMsRUFBRTtZQUN0QixNQUFN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Q0FBQztJQUtPLEtBQUssQ0FBQyxXQUFXLENBQUMsUUFBa0I7UUFFMUMsSUFBSSxPQUFPLFFBQVEsS0FBSyxRQUFRLElBQUksQ0FBQyxDQUFDLFFBQVEsWUFBWSxLQUFLLENBQUMsRUFBRTtZQUNoRSxNQUFNLElBQUksU0FBUyxDQUFDLDJEQUEyRCxDQUFDLENBQUE7U0FDakY7UUFFRCxNQUFNLFFBQVEsR0FBRyxRQUFRO2FBQ3RCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2FBQ3ZELE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDO2FBQzNCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVuQixJQUFJLFFBQVEsQ0FBQyxNQUFNLEVBQUU7WUFDbkIsTUFBTSxPQUFPLEdBQUcsd0JBQXdCLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQTtZQUM1RCxNQUFNLElBQUksU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1NBQzdCO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGljdGlvbmFyeSB9IGZyb20gJy4uL2NvbW1vbi9jb3JlL0V2ZW50RGlzcGF0Y2hlcidcbmltcG9ydCB7IFRyYW5zcG9ydEJhc2VkU2VydmVyIH0gZnJvbSAnLi9UcmFuc3BvcnRCYXNlZFNlcnZlcidcbmltcG9ydCB7IEFQSUNsYXNzLCBBUEksIEFQSU9wdGlvbnMgfSBmcm9tICcuL0FQSSdcbmltcG9ydCB7IFNjcmlwdGluZ1RyYW5zcG9ydCB9IGZyb20gJy4uL2NvbW1vbi9qc29uLXJwYy90eXBlcydcblxuLy8gSWYgdGhlcmUgaXMgbm8gbmF0aXZlIFN5bWJvbFxuLy8gbm9yIHBvbHlmaWxsLCB0aGVuIGEgcGxhaW4gbnVtYmVyIGlzIHVzZWQgZm9yIHBlcmZvcm1hbmNlLlxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG5jb25zdCBoYXNTeW1ib2wgPSB0eXBlb2YgU3ltYm9sID09PSAnZnVuY3Rpb24nICYmIFN5bWJvbC5mb3JcblxuY29uc3QgYXBpTmFtZVN5bWJvbDogYW55ID0gaGFzU3ltYm9sID8gU3ltYm9sKCdwbHVnaW5OYW1lJykgOiAweGZlYTJcblxuY29uc3QgcmVnaXN0ZXJlZEFQSXM6IERpY3Rpb25hcnk8QVBJQ2xhc3M8QVBJPj4gPSB7fVxuXG5uYW1lc3BhY2UgUHJpdmF0ZUhlbHBlcnMge1xuICBleHBvcnQgZnVuY3Rpb24gX3JlZ2lzdGVyQVBJKGFwaU5hbWU6IHN0cmluZywgYXBpOiBBUElDbGFzczxBUEk+KSB7XG4gICAgaWYgKGFwaU5hbWVTeW1ib2wgaW4gYXBpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBBUEkgeW91IGFyZSB0cnlpbmcgdG8gcmVnaXN0ZXIgaXMgYWxyZWFkeSByZWdpc3RlcmVkYClcbiAgICB9XG5cbiAgICBpZiAoYXBpTmFtZSBpbiByZWdpc3RlcmVkQVBJcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgQVBJICR7YXBpTmFtZX0gaXMgYWxyZWFkeSByZWdpc3RlcmVkYClcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIChhcGkgYXMgYW55KSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgQVBJICR7YXBpTmFtZX0gaXMgbm90IGEgY2xhc3MsIGl0IGlzIG9mIHR5cGUgJHt0eXBlb2YgYXBpfWApXG4gICAgfVxuXG4gICAgLy8gc2F2ZSB0aGUgcmVnaXN0ZXJlZCBuYW1lXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnNlbWljb2xvblxuICAgIDsoYXBpIGFzIGFueSlbYXBpTmFtZVN5bWJvbF0gPSBhcGlOYW1lXG5cbiAgICByZWdpc3RlcmVkQVBJc1thcGlOYW1lXSA9IGFwaVxuICB9XG5cbiAgZXhwb3J0IGZ1bmN0aW9uIHVubW91bnRBUEkoYXBpOiBBUEkpIHtcbiAgICBpZiAoYXBpLmFwaVdpbGxVbm1vdW50KSB7XG4gICAgICBjb25zdCBwcm9taXNlID0gYXBpLmFwaVdpbGxVbm1vdW50KClcbiAgICAgIGlmIChwcm9taXNlICYmICdjYXRjaCcgaW4gcHJvbWlzZSkge1xuICAgICAgICBwcm9taXNlLmNhdGNoKGVycm9yID0+IGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHVubW91bnRpbmcgQVBJJywgeyBhcGksIGVycm9yIH0pKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGV4cG9ydCBmdW5jdGlvbiBtb3VudEFQSShhcGk6IEFQSSkge1xuICAgIGlmIChhcGkuYXBpRGlkTW91bnQpIHtcbiAgICAgIGNvbnN0IHByb21pc2UgPSBhcGkuYXBpRGlkTW91bnQoKVxuICAgICAgaWYgKHByb21pc2UgJiYgJ2NhdGNoJyBpbiBwcm9taXNlKSB7XG4gICAgICAgIHByb21pc2UuY2F0Y2goZXJyb3IgPT4gY29uc29sZS5lcnJvcignRXJyb3IgbW91bnRpbmcgQVBJJywgeyBhcGksIGVycm9yIH0pKVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG4vLyBIRVJFIFdFIFNUQVJUIFRIRSBFWFBPUlRTXG5cbmV4cG9ydCBlbnVtIFNjcmlwdGluZ0hvc3RFdmVudHMge1xuICBzeXN0ZW1XaWxsVW5tb3VudCA9ICdzeXN0ZW1XaWxsVW5tb3VudCcsXG4gIHN5c3RlbVdpbGxFbmFibGUgPSAnc3lzdGVtV2lsbEVuYWJsZScsXG4gIHN5c3RlbURpZFVubW91bnQgPSAnc3lzdGVtRGlkVW5tb3VudCdcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEFQSU5hbWUoa2xhc3M6IEFQSUNsYXNzPEFQST4pOiBzdHJpbmcgfCBudWxsIHtcbiAgcmV0dXJuIChrbGFzcyBhcyBhbnkpW2FwaU5hbWVTeW1ib2xdIHx8IGtsYXNzLm5hbWUgfHwgbnVsbFxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJBUEkoYXBpTmFtZTogc3RyaW5nKTogKGtsYXNzOiBBUElDbGFzczxBUEk+KSA9PiB2b2lkIHtcbiAgcmV0dXJuIGZ1bmN0aW9uKGFwaTogQVBJQ2xhc3M8QVBJPikge1xuICAgIFByaXZhdGVIZWxwZXJzLl9yZWdpc3RlckFQSShhcGlOYW1lLCBhcGkpXG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFNjcmlwdGluZ0hvc3QgZXh0ZW5kcyBUcmFuc3BvcnRCYXNlZFNlcnZlciB7XG4gIHVubW91bnRlZCA9IGZhbHNlXG5cbiAgYXBpSW5zdGFuY2VzOiBNYXA8c3RyaW5nLCBBUEk+ID0gbmV3IE1hcCgpXG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcih3b3JrZXI6IFNjcmlwdGluZ1RyYW5zcG9ydCkge1xuICAgIHN1cGVyKHdvcmtlcilcblxuICAgIHRoaXMuZXhwb3NlKCdMb2FkQ29tcG9uZW50cycsIHRoaXMuUlBDTG9hZEFQSXMuYmluZCh0aGlzKSlcbiAgfVxuXG4gIHN0YXRpYyBhc3luYyBmcm9tVHJhbnNwb3J0KHRyYW5zcG9ydDogU2NyaXB0aW5nVHJhbnNwb3J0KSB7XG4gICAgcmV0dXJuIG5ldyBTY3JpcHRpbmdIb3N0KHRyYW5zcG9ydClcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhkb2Qgc2hvdWxkIGJlIGNhbGxlZCBvbmx5IGZyb20gdGhlIGludGVyZmFjZSB0aGF0IG1hbmFnZXMgdGhlIFNjcmlwdGluZ0hvc3RzLlxuICAgKiBJdCBpbml0aWFsaXplcyB0aGUgc3lzdGVtIGFuZCBpdCdzIHF1ZXVlZCBjb21wb25lbnRzLiBJdCBhbHNvIHNlbmRzIGEgZmlyc3Qgbm90aWZpY2F0aW9uXG4gICAqIHRvIHRoZSBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgc3lzdGVtIHRlbGxpbmcgaXQgaXMgbm93IGVuYWJsZWQuIEluIHRoYXQgbW9tZW50LCB0aGVcbiAgICogaW1wbGVtZW50YXRpb24gd2lsbCBzZW5kIHRoZSBxdWV1ZWQgbWVzc2FnZXMgYW5kIGV4ZWN1dGUgdGhlIHF1ZXVlZCBtZXRob2RzIGFnYWluc3QgdGhlXG4gICAqIG1hdGVyaWFsaXplZCBjb21wb25lbnRzLlxuICAgKlxuICAgKiBJdDpcbiAgICogIDEpIGVtaXRzIGEgQ29tcG9uZW50U3lzdGVtRXZlbnRzLnN5c3RlbVdpbGxFbmFibGUgZXZlbnRcbiAgICogIDIpIG1vdW50cyBhbGwgdGhlIGNvbXBvbmVudHNcbiAgICogIDMpIHNlbmRzIHRoZSBub3RpZmljYXRpb24gdG8gdGhlIGFjdHVhbCBzeXN0ZW0gaW1wbGVtZW50YXRpb25cbiAgICovXG4gIGVuYWJsZSgpIHtcbiAgICB0aGlzLmVtaXQoU2NyaXB0aW5nSG9zdEV2ZW50cy5zeXN0ZW1XaWxsRW5hYmxlKVxuICAgIHRoaXMuYXBpSW5zdGFuY2VzLmZvckVhY2goUHJpdmF0ZUhlbHBlcnMubW91bnRBUEkpXG4gICAgc3VwZXIuZW5hYmxlKClcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGlzIGEgc2VydmljZSBsb2NhdG9yLCBpdCBsb2NhdGVzIG9yIGluc3RhbnRpYXRlIHRoZSByZXF1ZXN0ZWQgY29tcG9uZW50XG4gICAqIGZvciB0aGlzIGluc3RhbmNlIG9mIENvbXBvbmVudFN5c3RlbS5cbiAgICpcbiAgICogQHBhcmFtIGFwaSBBIGNsYXNzIGNvbnN0cnVjdG9yXG4gICAqL1xuICBnZXRBUElJbnN0YW5jZTxYPihhcGk6IHsgbmV3IChvcHRpb25zOiBBUElPcHRpb25zKTogWCB9KTogWFxuXG4gIC8qKlxuICAgKiBUaGlzIGlzIGEgc2VydmljZSBsb2NhdG9yLCBpdCBsb2NhdGVzIG9yIGluc3RhbnRpYXRlIHRoZSByZXF1ZXN0ZWQgY29tcG9uZW50XG4gICAqIGZvciB0aGlzIGluc3RhbmNlIG9mIENvbXBvbmVudFN5c3RlbS5cbiAgICpcbiAgICogQHBhcmFtIG5hbWUgVGhlIG5hbWUgb2YgdXNlZCB0byByZWdpc3RlciB0aGUgY29tcG9uZW50XG4gICAqL1xuICBnZXRBUElJbnN0YW5jZShuYW1lOiBzdHJpbmcpOiBBUEkgfCBudWxsXG5cbiAgZ2V0QVBJSW5zdGFuY2UoYXBpOiBhbnkpIHtcbiAgICBpZiAodHlwZW9mIGFwaSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGlmICh0aGlzLmFwaUluc3RhbmNlcy5oYXMoYXBpKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5hcGlJbnN0YW5jZXMuZ2V0KGFwaSlcbiAgICAgIH1cbiAgICAgIGlmIChhcGkgaW4gcmVnaXN0ZXJlZEFQSXMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5pdGlhbGl6ZUFQSShyZWdpc3RlcmVkQVBJc1thcGldKVxuICAgICAgfVxuICAgICAgcmV0dXJuIG51bGxcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcGkgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGNvbnN0IGFwaU5hbWUgPSBnZXRBUElOYW1lKGFwaSlcblxuICAgICAgLy8gaWYgaXQgaGFzIGEgbmFtZSwgdXNlIHRoYXQgaW5kaXJlY3Rpb24gdG8gZmluZCBpbiB0aGUgaW5zdGFuY2UncyBtYXBcbiAgICAgIGlmIChhcGlOYW1lICE9PSBudWxsKSB7XG4gICAgICAgIGlmICh0aGlzLmFwaUluc3RhbmNlcy5oYXMoYXBpTmFtZSkpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hcGlJbnN0YW5jZXMuZ2V0KGFwaU5hbWUpXG4gICAgICAgIH1cblxuICAgICAgICAvLyBJZiB3ZSBkb24ndCBoYXZlIGEgbG9jYWwgaW5zdGFuY2UsIGNyZWF0ZSB0aGUgaW5zdGFuY2Ugb2YgdGhlIGNvbXBvbmVudFxuICAgICAgICByZXR1cm4gdGhpcy5pbml0aWFsaXplQVBJKGFwaSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aHJvdyBPYmplY3QuYXNzaWduKG5ldyBFcnJvcignQ2Fubm90IGdldCBpbnN0YW5jZSBvZiB0aGUgc3BlY2lmaWVkIGNvbXBvbmVudCcpLCB7IGFwaSB9KVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIHVubW91bnRzIGFsbCB0aGUgY29tcG9uZW50cyBhbmQgcmVsZWFzZXMgdGhlIFdvcmtlclxuICAgKi9cbiAgdW5tb3VudCgpIHtcbiAgICBpZiAodGhpcy51bm1vdW50ZWQpIHJldHVyblxuICAgIHRoaXMubm90aWZ5KCdTSUdLSUxMJylcblxuICAgIHRoaXMuZW1pdChTY3JpcHRpbmdIb3N0RXZlbnRzLnN5c3RlbVdpbGxVbm1vdW50KVxuXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuYXBpSW5zdGFuY2VzLmZvckVhY2goUHJpdmF0ZUhlbHBlcnMudW5tb3VudEFQSSlcbiAgICAgIHRoaXMuYXBpSW5zdGFuY2VzLmNsZWFyKClcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZSlcbiAgICB9XG5cbiAgICB0aGlzLnRyYW5zcG9ydC5jbG9zZSgpXG5cbiAgICB0aGlzLmVtaXQoU2NyaXB0aW5nSG9zdEV2ZW50cy5zeXN0ZW1EaWRVbm1vdW50KVxuXG4gICAgdGhpcy51bm1vdW50ZWQgPSB0cnVlXG4gIH1cblxuICBwcm90ZWN0ZWQgaW5pdGlhbGl6ZUFQSTxYIGV4dGVuZHMgQVBJPihjdG9yOiB7XG4gICAgbmV3IChvcHRpb25zOiBBUElPcHRpb25zKTogWFxuICAgIGZhY3Rvcnk/KGN0b3I6IHsgbmV3IChvcHRpb25zOiBBUElPcHRpb25zKTogWCB9LCBvcHRpb25zOiBBUElPcHRpb25zKTogWFxuICB9KTogWCB7XG4gICAgY29uc3QgYXBpTmFtZSA9IGdldEFQSU5hbWUoY3RvcilcblxuICAgIGlmIChhcGlOYW1lID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBwbHVnaW4gaXMgbm90IHJlZ2lzdGVyZWQnKVxuICAgIH1cblxuICAgIGlmICh0aGlzLmFwaUluc3RhbmNlcy5oYXMoYXBpTmFtZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmFwaUluc3RhbmNlcy5nZXQoYXBpTmFtZSkgYXMgWFxuICAgIH1cblxuICAgIGNvbnN0IGFwaU9wdGlvbnM6IEFQSU9wdGlvbnMgPSB7XG4gICAgICBhcGlOYW1lLFxuICAgICAgb246IChldmVudCwgaGFuZGxlcikgPT4gdGhpcy5vbihgJHthcGlOYW1lfS4ke2V2ZW50fWAsIGhhbmRsZXIpLFxuICAgICAgbm90aWZ5OiAoZXZlbnQsIHBhcmFtcz8pID0+IHRoaXMubm90aWZ5KGAke2FwaU5hbWV9LiR7ZXZlbnR9YCwgcGFyYW1zKSxcbiAgICAgIGV4cG9zZTogKGV2ZW50LCBoYW5kbGVyKSA9PiB0aGlzLmV4cG9zZShgJHthcGlOYW1lfS4ke2V2ZW50fWAsIGhhbmRsZXIpLFxuICAgICAgZ2V0QVBJSW5zdGFuY2U6IChuYW1lOiBhbnkpID0+IHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gICAgICAgIHJldHVybiB0aGlzLmdldEFQSUluc3RhbmNlKG5hbWUpIGFzIGFueVxuICAgICAgfSxcbiAgICAgIHN5c3RlbTogdGhpc1xuICAgIH1cblxuICAgIGNvbnN0IGluc3RhbmNlID0gY3Rvci5mYWN0b3J5ID8gY3Rvci5mYWN0b3J5KGN0b3IsIGFwaU9wdGlvbnMpIDogbmV3IGN0b3IoYXBpT3B0aW9ucylcblxuICAgIHRoaXMuYXBpSW5zdGFuY2VzLnNldChhcGlOYW1lLCBpbnN0YW5jZSlcblxuICAgIHJldHVybiBpbnN0YW5jZVxuICB9XG5cbiAgLyoqXG4gICAqIFByZWxvYWRzIGEgbGlzdCBvZiBjb21wb25lbnRzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIFJQQ0xvYWRBUElzKGFwaU5hbWVzOiBzdHJpbmdbXSkge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuICAgIGlmICh0eXBlb2YgYXBpTmFtZXMgIT09ICdvYmplY3QnIHx8ICEoYXBpTmFtZXMgaW5zdGFuY2VvZiBBcnJheSkpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1JQQ0xvYWRDb21wb25lbnRzKG5hbWVzKSBuYW1lIG11c3QgYmUgYW4gYXJyYXkgb2Ygc3RyaW5ncycpXG4gICAgfVxuXG4gICAgY29uc3Qgbm90Rm91bmQgPSBhcGlOYW1lc1xuICAgICAgLm1hcChuYW1lID0+ICh7IGFwaTogdGhpcy5nZXRBUElJbnN0YW5jZShuYW1lKSwgbmFtZSB9KSlcbiAgICAgIC5maWx0ZXIoJCA9PiAkLmFwaSA9PT0gbnVsbClcbiAgICAgIC5tYXAoJCA9PiAkLm5hbWUpXG5cbiAgICBpZiAobm90Rm91bmQubGVuZ3RoKSB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gYENvbXBvbmVudHMgbm90IGZvdW5kICR7bm90Rm91bmQuam9pbignLCcpfWBcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IobWVzc2FnZSlcbiAgICB9XG4gIH1cbn1cbiJdfQ==